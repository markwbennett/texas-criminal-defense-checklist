<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive criminal defense checklist manager by the Institute for Advanced Criminal Law Studies">
    <meta name="author" content="Institute for Advanced Criminal Law Studies">
    <title>Criminal Defense Checklist | IACLS.org</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            transition: background 0.3s, color 0.3s;
        }

        /* Dark theme */
        body.dark-theme {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-theme .card {
            background: #2d2d2d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        body.dark-theme header {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
        }

        body.dark-theme .client-card {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        body.dark-theme .client-card:hover {
            background: #4a4a4a;
        }

        body.dark-theme .form-section {
            background: #2a2a2a;
            border-left-color: #3498db;
        }

        body.dark-theme .form-section-content {
            color: #b0b0b0;
        }

        body.dark-theme .note {
            color: #888;
        }

        body.dark-theme .item-content:hover {
            background: #3a3a3a;
        }

        body.dark-theme .search-box,
        body.dark-theme input {
            background: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }

        body.dark-theme .modal {
            background: rgba(0,0,0,0.8);
        }

        body.dark-theme .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-theme .progress-bar {
            background: #3a3a3a;
        }

        body.dark-theme .header-subtitle {
            color: #999;
        }

        body.dark-theme .iacls-link {
            color: #5dade2;
        }

        body.dark-theme #template-info {
            background: #1e4620;
            color: #a8e6a3;
        }

        body.dark-theme .backup-warning {
            background: #3a2f1f !important;
            border-left-color: #f39c12 !important;
            color: #ffd78a !important;
        }

        body.dark-theme .privilege-notice {
            background: #1e3a20 !important;
            border-left-color: #27ae60 !important;
        }

        body.dark-theme .privilege-notice h3 {
            color: #5ddb6a !important;
        }

        body.dark-theme .privilege-notice p {
            color: #a8e6a3 !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .iacls-logo {
            width: 80px;
            height: 80px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .iacls-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-text {
            flex: 1;
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 14px;
            color: #bdc3c7;
            margin-bottom: 5px;
        }

        .iacls-link {
            color: #3498db;
            text-decoration: none;
            font-size: 13px;
        }

        .iacls-link:hover {
            text-decoration: underline;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        #welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }

        #welcome-screen h2 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        #welcome-screen p {
            margin-bottom: 20px;
            color: #666;
        }

        #template-upload {
            display: none;
        }

        #template-info {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .client-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .client-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .client-card:hover {
            background: #d5dbdb;
            border-color: #3498db;
        }

        .client-card h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .client-card .progress {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .client-card .actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .client-card button {
            padding: 5px 10px;
            font-size: 12px;
        }

        #checklist-container {
            display: none;
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .checklist-header h2 {
            margin: 0;
        }

        .checklist-actions {
            display: flex;
            gap: 10px;
        }

        .checklist-item {
            margin-left: 20px;
            margin-bottom: 8px;
        }

        .checklist-item.level-0 {
            margin-left: 0;
            font-weight: bold;
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 15px;
        }

        .item-content {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 5px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .item-content:hover {
            background: #f8f9fa;
        }

        .item-content input[type="checkbox"] {
            margin-top: 4px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .item-text {
            flex: 1;
            user-select: none;
            cursor: pointer;
        }

        .item-text.completed {
            color: #95a5a6;
            text-decoration: line-through;
        }

        .item-progress {
            font-size: 12px;
            color: #7f8c8d;
            margin-left: 5px;
        }

        .toggle-icon {
            cursor: pointer;
            user-select: none;
            width: 20px;
            text-align: center;
            color: #7f8c8d;
        }

        .children-collapsed {
            display: none;
        }

        .form-section {
            background: #f8f9fa;
            border-left: 3px solid #3498db;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .form-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .form-section-title {
            font-weight: bold;
            color: #2c3e50;
        }

        .form-section-content {
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            color: #666;
        }

        .print-form-btn {
            padding: 5px 15px;
            font-size: 12px;
            background: #27ae60;
        }

        .print-form-btn:hover {
            background: #229954;
        }

        .print-section-btn {
            padding: 3px 8px;
            font-size: 11px;
            background: #95a5a6;
            margin-left: 10px;
            border-radius: 3px;
        }

        .print-section-btn:hover {
            background: #7f8c8d;
        }

        .note {
            color: #7f8c8d;
            font-style: italic;
            margin-left: 28px;
            font-size: 14px;
        }

        .progress-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 15px;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        @media print {
            body {
                background: white;
            }

            header, .header-actions, .checklist-actions, button {
                display: none !important;
            }

            .card {
                box-shadow: none;
                page-break-inside: avoid;
            }

            .checklist-item {
                page-break-inside: avoid;
            }
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 40px;
        }

        footer a {
            color: #3498db;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media print {
            footer {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-top {
                flex-direction: column;
                text-align: center;
            }

            .iacls-logo {
                width: 60px;
                height: 60px;
            }

            header h1 {
                font-size: 20px;
            }

            .checklist-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .client-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="iacls-logo">
                    <img src="data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20standalone%3D%22no%22%3F%3E%0A%3C%21DOCTYPE%20svg%20PUBLIC%20%22-//W3C//DTD%20SVG%2020010904//EN%22%0A%20%22http%3A//www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd%22%3E%0A%3Csvg%20version%3D%221.0%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%0A%20width%3D%22600.000000pt%22%20height%3D%22600.000000pt%22%20viewBox%3D%220%200%20600.000000%20600.000000%22%0A%20preserveAspectRatio%3D%22xMidYMid%20meet%22%3E%0A%3Cmetadata%3E%0ACreated%20by%20potrace%201.16%2C%20written%20by%20Peter%20Selinger%202001-2019%0A%3C/metadata%3E%0A%3Cg%20transform%3D%22translate%280.000000%2C600.000000%29%20scale%280.100000%2C-0.100000%29%22%0Afill%3D%22%23000000%22%20stroke%3D%22none%22%3E%0A%3Cpath%20d%3D%22M0%203000%20l0%20-3000%203000%200%203000%200%200%203000%200%203000%20-3000%200%20-3000%200%200%0A-3000z%20m1257%202299%20c462%20-119%20684%20-199%201008%20-364%20397%20-203%20739%20-449%201046%20-755%0A177%20-176%20305%20-329%20381%20-456%2052%20-88%20146%20-272%20178%20-349%2020%20-49%2018%20-47%20-102%2080%0A-549%20584%20-935%20920%20-1213%201056%20-71%2035%20-76%2036%20-45%2012%20274%20-218%20571%20-486%20820%0A-739%20200%20-204%20490%20-519%20498%20-544%202%20-5%20-10%20-16%20-26%20-24%20-27%20-14%20-31%20-14%20-47%204%0A-30%2034%20-118%2068%20-215%2084%20-199%2034%20-265%2048%20-324%2067%20-72%2024%20-181%2088%20-169%2099%204%204%0A37%2012%2073%2017%2036%206%2094%2024%20130%2040%20l65%2030%20-115%207%20c-378%2024%20-620%20117%20-915%20352%20-49%0A39%20-107%2089%20-128%20111%20l-38%2040%2089%206%20c98%206%20198%2029%20252%2057%20l35%2019%20-131%201%20c-212%200%0A-326%2033%20-463%20133%20-60%2043%20-234%20216%20-252%20249%20-10%2019%20-9%2020%2012%2014%2048%20-15%20312%20-19%0A412%20-6%2054%207%2096%2014%2094%2016%20-2%202%20-66%2013%20-143%2024%20-308%2043%20-414%2077%20-554%20181%20-103%0A75%20-252%20276%20-351%20471%20-39%2078%20-47%20108%20-29%20108%205%200%2081%20-18%20167%20-41z%20m3014%20-1872%0Ac19%20-12%2043%20-39%2054%20-59%2018%20-33%2018%20-39%205%20-67%20-28%20-59%20-114%20-161%20-130%20-154%20-8%203%0A-61%2021%20-117%2040%20-57%2019%20-103%2038%20-103%2042%200%204%2031%2045%2068%2092%20105%20130%20154%20153%20223%0A106z%20m203%20-216%20c68%20-45%2083%20-111%2039%20-170%20-78%20-105%20-258%20-323%20-273%20-331%20-49%20-26%0A-108%206%20-97%2052%205%2019%2017%2026%2063%2036%20123%2025%20185%2094%20188%20207%201%2063%20-18%2090%20-77%20106%0Al-39%2010%2023%2027%20c70%2080%2072%2082%20108%2082%2020%200%2049%20-9%2065%20-19z%20m-400%20-106%20c72%20-24%20150%0A-49%20174%20-55%2077%20-20%2090%20-80%2029%20-139%20-39%20-39%20-116%20-56%20-212%20-47%20-38%204%20-79%208%20-90%0A8%20-22%200%20-135%20-44%20-135%20-53%200%20-3%2030%20-11%2067%20-17%2074%20-12%2087%20-23%20104%20-87%2020%20-72%205%0A-160%20-44%20-258%20l-45%20-87%2037%2021%20c55%2034%2089%2068%20129%20132%2033%2054%2038%2058%2065%2053%2032%20-7%0A95%20-54%20192%20-144%20l63%20-60%20-62%20-78%20c-113%20-143%20-177%20-187%20-301%20-210%20-85%20-16%20-92%0A-20%20-144%20-68%20-47%20-44%20-393%20-425%20-475%20-523%20-80%20-95%20-373%20-319%20-521%20-398%20-44%0A-24%20-58%20-26%20-115%20-21%20-58%205%20-95%2020%20-340%20142%20-393%20194%20-611%20329%20-752%20465%20-89%0A85%20-62%20137%20143%20281%2092%2065%20172%20155%20201%20225%2020%2051%2023%2074%2023%20198%200%20125%20-3%20151%0A-29%20238%20-16%2053%20-26%20100%20-23%20103%2010%2011%2074%20-16%20139%20-58%2092%20-59%20200%20-150%20303%0A-253%2074%20-73%2099%20-106%20133%20-175%2022%20-47%2045%20-104%2051%20-128%209%20-42%208%20-45%20-36%20-100%0A-25%20-31%20-51%20-63%20-57%20-71%20-20%20-26%2033%20-2%20189%2084%2083%2045%20179%2097%20215%20114%20132%2066%0A409%20263%20503%20358%20l58%2059%2015%20120%20c32%20246%2050%20305%20101%20342%2083%2058%20242%20130%20292%20131%0A13%201%2083%20-19%20155%20-44z%20m575%20-140%20c22%20-25%2031%20-46%2031%20-71%200%20-31%20-13%20-48%20-125%0A-163%20-141%20-144%20-180%20-171%20-219%20-153%20-15%206%20-32%2023%20-38%2037%20-10%2023%20-7%2032%2032%2088%0A70%2099%20186%20242%20220%20270%2042%2036%2062%2034%2099%20-8z%20m90%20-213%20c46%20-66%2035%20-110%20-46%20-182%0A-66%20-58%20-141%20-100%20-180%20-100%20-39%200%20-77%2032%20-68%2059%2010%2031%20231%20251%20253%20251%2011%200%0A30%20-13%2041%20-28z%20m15%20-477%20c107%20-161%20129%20-198%20112%20-188%20-49%2028%20-326%20287%20-315%0A296%202%202%2022%2016%2044%2030%20l39%2027%2023%20-28%20c13%20-15%2056%20-76%2097%20-137z%20m-1725%20-1472%20c1%0A-17%20-3%20-35%20-9%20-38%20-5%20-3%20-10%202%20-10%2013%200%2027%20-44%2065%20-76%2065%20-27%200%20-64%20-33%20-64%0A-57%200%20-24%2033%20-57%20100%20-100%2038%20-25%2076%20-56%2085%20-70%2025%20-37%2021%20-118%20-6%20-163%20-37%0A-60%20-134%20-90%20-205%20-63%20-20%208%20-29%208%20-34%20-1%20-12%20-19%20-20%205%20-26%2078%20l-4%2068%2019%20-42%0Ac21%20-45%2071%20-83%20109%20-83%2030%200%2078%2025%2086%2045%203%209%206%2030%206%2047%200%2034%20-42%2081%20-123%20135%0A-50%2034%20-67%2064%20-67%20114%200%2076%2059%20125%20142%20117%2029%20-3%2051%20-1%2055%206%209%2013%2021%20-26%2022%0A-71z%20m1629%20-7%20c3%20-73%20-10%20-87%20-28%20-31%20-16%2048%20-44%2065%20-108%2065%20-63%200%20-98%20-16%0A-140%20-64%20-71%20-82%20-49%20-252%2043%20-322%2037%20-28%20104%20-41%20150%20-30%2025%206%2026%208%2023%2078%20-3%0A69%20-5%2073%20-35%2094%20l-31%2021%20100%200%20c56%20-1%2095%20-3%2087%20-5%20-28%20-8%20-39%20-37%20-39%20-97%200%0A-52%20-4%20-65%20-23%20-83%20-72%20-68%20-221%20-51%20-315%2033%20-119%20107%20-108%20261%2026%20358%2055%2040%0A121%2056%20212%2052%20l75%20-4%203%20-65z%20m-3055%2054%20c-40%20-16%20-46%20-46%20-51%20-236%20-5%20-199%20-1%0A-214%2058%20-214%2026%200%2031%207%2060%2077%2032%2076%20104%20262%20131%20338%208%2022%2019%2040%2023%2040%205%200%2034%0A-67%2066%20-150%2065%20-170%2097%20-238%20135%20-284%20l27%20-31%20-94%201%20c-74%200%20-88%203%20-70%2011%2028%0A14%2028%2034%20-2%20103%20l-25%2055%20-55%200%20-54%200%20-21%20-62%20c-26%20-75%20-26%20-95%20-3%20-101%209%20-3%0A-55%20-5%20-143%20-6%20-88%200%20-155%203%20-148%207%2024%2015%2032%2063%2039%20237%20l7%20178%20-29%2024%20-29%2023%0A100%20-1%20c68%200%2093%20-3%2078%20-9z%20m787%20-47%20c0%20-54%20-13%20-70%20-25%20-32%20-10%2029%20-64%2059%0A-108%2059%20-97%200%20-167%20-87%20-167%20-208%200%20-169%20158%20-253%20273%20-144%2030%2029%2031%2028%2016%0A-31%20-10%20-43%20-10%20-43%20-74%20-55%20-138%20-26%20-204%20-6%20-262%2081%20-80%20120%20-37%20298%2088%20361%0A50%2025%2062%2027%20156%2024%20l103%20-3%200%20-52z%20m186%2035%20c-13%20-18%20-16%20-56%20-16%20-210%200%20-214%0A-2%20-208%2088%20-208%2035%200%2057%206%2075%2020%20l26%2021%20-13%20-38%20c-7%20-21%20-18%20-38%20-25%20-37%20-6%201%0A-68%202%20-137%203%20-114%201%20-125%203%20-113%2017%209%2011%2015%2077%2021%20217%209%20200%209%20202%20-13%20220%0A-21%2017%20-19%2017%2050%2017%20l72%200%20-15%20-22z%20m1145%20-6%20c34%20-17%2065%20-44%2084%20-71%2028%20-40%2030%0A-49%2030%20-130%200%20-80%20-3%20-92%20-30%20-137%20-77%20-123%20-275%20-147%20-387%20-46%20-82%2074%20-105%0A180%20-59%20275%2060%20123%20235%20176%20362%20109z%20m431%20-10%20c40%20-24%2064%20-89%2048%20-136%20-11%20-33%0A-53%20-79%20-82%20-88%20-19%20-7%2067%20-144%20132%20-209%2063%20-64%20131%20-102%20222%20-125%2074%20-19%20130%0A-14%20206%2021%2069%2031%2082%2032%2052%200%20-49%20-52%20-186%20-76%20-294%20-51%20-139%2033%20-254%20117%20-354%0A259%20-30%2043%20-63%2084%20-73%2090%20-28%2017%20-23%2027%2011%2027%2071%200%20119%2056%20106%20123%20-9%2050%20-46%0A79%20-105%2085%20-48%204%20-50%203%20-57%20-23%20-4%20-15%20-5%20-106%20-2%20-202%205%20-171%206%20-176%2029%20-194%0A24%20-18%2024%20-19%20-59%20-19%20l-83%200%2015%2022%20c13%2019%2016%2058%2016%20223%200%20147%20-3%20205%20-12%20214%0A-20%2021%20246%206%20284%20-17z%20m-916%20-347%20c24%20-24%2025%20-28%2011%20-48%20-18%20-28%20-53%20-33%20-78%0A-11%20-25%2023%20-24%2049%203%2068%2030%2021%2035%2020%2064%20-9z%22/%3E%0A%3Cpath%20d%3D%22M1787%20665%20c-22%20-65%20-22%20-65%2018%20-65%2040%200%2042%206%2016%2069%20l-18%2044%20-16%20-48z%22/%3E%0A%3Cpath%20d%3D%22M3500%20811%20c-20%20-10%20-44%20-36%20-58%20-62%20-32%20-59%20-27%20-153%2012%20-233%2033%20-67%0A70%20-95%20133%20-102%2062%20-7%20128%2026%20155%2076%2023%2044%2024%20135%201%20192%20-48%20127%20-149%20180%0A-243%20129z%22/%3E%0A%3C/g%3E%0A%3C/svg%3E%0A" alt="IACLS Logo">
                </div>
                <div class="header-text">
                    <h1>Criminal Defense Checklist Manager</h1>
                    <div class="header-subtitle">Institute for Advanced Criminal Law Studies</div>
                    <a href="https://iacls.org" target="_blank" class="iacls-link">iacls.org</a>
                </div>
            </div>
            <div id="template-status"></div>
            <div class="header-actions">
                <label for="template-upload">
                    <button type="button" onclick="document.getElementById('template-upload').click()">
                        📁 Load Template
                    </button>
                </label>
                <input type="file" id="template-upload" accept=".txt">
                <button id="new-client-btn" onclick="showNewClientModal()" disabled>
                    ➕ New Client
                </button>
                <button onclick="showImportModal()">
                    📥 Import Client
                </button>
                <button onclick="exportAllClients()">
                    📦 Export All
                </button>
                <button onclick="showImportAllModal()">
                    📂 Import All
                </button>
                <button id="theme-toggle" onclick="toggleTheme()">
                    🌙 Dark
                </button>
                <button class="danger" onclick="clearLocalStorage()">
                    🗑️ Clear Storage
                </button>
            </div>
        </header>

        <div class="card privilege-notice" style="background: #e8f5e9; border-left: 4px solid #27ae60;">
            <h3 style="color: #1e7e34; margin-bottom: 10px;">🔒 Attorney-Client Privilege Protected</h3>
            <p style="margin: 0; font-size: 14px; line-height: 1.6; color: #155724;">
                This application stores all client data <strong>exclusively on your local computer</strong> in your browser's private storage.
                No data is ever transmitted to any server or third party. All information remains confidential and protected by attorney-client privilege.
                Optional password encryption provides additional security for backup files stored in cloud services or shared locations.
                For maximum security, use encrypted backups and clear your browser's local storage when using shared computers.
            </p>
        </div>

        <div id="welcome-screen" class="card">
            <h2>Welcome to the Criminal Defense Checklist Manager</h2>
            <p style="color: #7f8c8d; margin-bottom: 20px;">
                Developed by the Institute for Advanced Criminal Law Studies
            </p>
            <p>To get started, please load your checklist template file:</p>
            <label for="template-upload-main">
                <button type="button" onclick="document.getElementById('template-upload').click()">
                    📁 Load Template File
                </button>
            </label>
            <p style="margin-top: 20px; font-size: 14px; color: #7f8c8d;">
                Select the <strong>CriminalDefenseChecklist.txt</strong> file
            </p>
        </div>

        <div id="clients-screen" style="display: none;">
            <div class="card backup-warning" style="background: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                <p style="margin: 0; font-size: 14px; color: #856404;">
                    <strong>⚠️ Important:</strong> Data is stored in your browser. Export your clients regularly to avoid data loss!
                    Click "Export" on each client to save a backup .json file.
                </p>
            </div>
            <div class="card">
                <h2>Your Clients</h2>
                <div id="client-list" class="client-list"></div>
                <div id="no-clients" style="text-align: center; padding: 40px; color: #95a5a6;">
                    No clients yet. Click "New Client" to create your first checklist.
                </div>
            </div>
        </div>

        <div id="checklist-container">
            <div class="card">
                <div class="checklist-header">
                    <div>
                        <h2 id="client-name"></h2>
                        <div id="overall-progress"></div>
                    </div>
                    <div class="checklist-actions">
                        <button onclick="saveChecklist()">💾 Save</button>
                        <button onclick="exportClient()">📤 Export</button>
                        <button onclick="printChecklist()">🖨️ Print All</button>
                        <button onclick="backToClients()">← Back</button>
                    </div>
                </div>

                <input type="text" class="search-box" id="search-box"
                       placeholder="🔍 Search checklist items..."
                       onkeyup="searchChecklist(this.value)">

                <div id="checklist-content"></div>
            </div>
        </div>
    </div>

    <!-- New Client Modal -->
    <div id="new-client-modal" class="modal">
        <div class="modal-content">
            <h3>Create New Client Checklist</h3>
            <input type="text" id="client-name-input" placeholder="Client Name">
            <input type="text" id="case-number-input" placeholder="Case Number (optional)">
            <div class="modal-actions">
                <button class="secondary" onclick="closeModal('new-client-modal')">Cancel</button>
                <button onclick="createClient()">Create</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <h3>Import Client Data</h3>
            <input type="file" id="import-file" accept=".json">
            <div class="modal-actions">
                <button class="secondary" onclick="closeModal('import-modal')">Cancel</button>
                <button onclick="importClient()">Import</button>
            </div>
        </div>
    </div>

    <!-- Import All Modal -->
    <div id="import-all-modal" class="modal">
        <div class="modal-content">
            <h3>Import All Clients</h3>
            <p style="color: #e74c3c; margin-bottom: 10px;">
                <strong>Warning:</strong> This will replace all existing clients with the imported data.
            </p>
            <input type="file" id="import-all-file" accept=".json">
            <div class="modal-actions">
                <button class="secondary" onclick="closeModal('import-all-modal')">Cancel</button>
                <button onclick="importAllClients()">Import All</button>
            </div>
        </div>
    </div>

    <!-- Export Encryption Modal -->
    <div id="export-encryption-modal" class="modal">
        <div class="modal-content">
            <h3>Encrypt Backup</h3>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                Enter a password to encrypt this backup. <strong>Keep this password safe!</strong> Without it, the backup cannot be restored.
            </p>
            <input type="password" id="export-password" placeholder="Enter encryption password">
            <input type="password" id="export-password-confirm" placeholder="Confirm password">
            <div class="modal-actions">
                <button class="secondary" onclick="closeModal('export-encryption-modal')">Cancel</button>
                <button onclick="confirmEncryptedExport()">Encrypt & Export</button>
            </div>
        </div>
    </div>

    <!-- Import Decryption Modal -->
    <div id="import-decryption-modal" class="modal">
        <div class="modal-content">
            <h3>Decrypt Backup</h3>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                This file is encrypted. Enter the password to decrypt and import.
            </p>
            <input type="password" id="import-password" placeholder="Enter decryption password">
            <div class="modal-actions">
                <button class="secondary" onclick="closeModal('import-decryption-modal')">Cancel</button>
                <button onclick="confirmDecryptedImport()">Decrypt & Import</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let template = null;
        let currentClient = null;
        let clients = [];
        let expandedItems = new Set(); // Track which items are expanded
        let pendingExportData = null; // For encryption flow
        let pendingImportData = null; // For decryption flow
        let pendingImportType = null; // 'single' or 'all'

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadClients();
            checkForCachedTemplate();
            autoLoadDefaultTemplate();
            loadTheme();

            document.getElementById('template-upload').addEventListener('change', handleTemplateUpload);
        });

        function checkForCachedTemplate() {
            const cached = localStorage.getItem('template');
            if (cached) {
                try {
                    template = JSON.parse(cached);
                    updateTemplateStatus();
                    if (clients.length > 0) {
                        showClientsScreen();
                    }
                } catch (e) {
                    console.error('Failed to load cached template:', e);
                }
            }
        }

        function autoLoadDefaultTemplate() {
            // If no cached template, try to load the default template file
            if (!template) {
                fetch('CriminalDefenseChecklist.txt')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Default template file not found');
                        }
                        return response.text();
                    })
                    .then(content => {
                        template = parseTemplate(content);
                        localStorage.setItem('template', JSON.stringify(template));
                        updateTemplateStatus();
                        if (clients.length > 0) {
                            showClientsScreen();
                        } else {
                            showClientsScreen();
                        }
                    })
                    .catch(error => {
                        console.log('No default template found, user must upload manually:', error);
                        // Template will need to be loaded manually
                    });
            } else if (clients.length > 0) {
                showClientsScreen();
            }
        }

        function handleTemplateUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    template = parseTemplate(content);
                    localStorage.setItem('template', JSON.stringify(template));
                    updateTemplateStatus();
                    if (clients.length > 0) {
                        showClientsScreen();
                    } else {
                        showClientsScreen();
                    }
                    alert('Template loaded successfully!');
                } catch (error) {
                    alert('Error parsing template: ' + error.message);
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        function parseTemplate(content) {
            const lines = content.split('\n');
            const root = { title: 'Root', children: [], level: -1 };
            const stack = [root];
            let inForm = false;
            let formContent = [];
            let formParent = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Check for #End command
                if (line.trim().toLowerCase() === '#end') {
                    break;
                }

                // Check for #FORM start
                if (line.trim().toUpperCase() === '#FORM') {
                    inForm = true;
                    formContent = [];
                    formParent = stack[stack.length - 1];
                    continue;
                }

                // Check for #FORMEND
                if (line.trim().toUpperCase() === '#FORMEND') {
                    if (inForm && formParent) {
                        formParent.children.push({
                            type: 'form',
                            title: formParent.title || 'Form',
                            content: formContent.join('\n'),
                            level: formParent.level + 1,
                            id: generateId((formParent.title || 'form') + '-form')
                        });
                    }
                    inForm = false;
                    formContent = [];
                    formParent = null;
                    continue;
                }

                // If in form, collect content
                if (inForm) {
                    formContent.push(line);
                    continue;
                }

                // Skip empty lines and comments (except #Note:)
                if (!line.trim()) continue;
                if (line.trim().startsWith('#') && !line.trim().startsWith('#Note:')) continue;

                // Count indentation (tabs)
                const level = (line.match(/^\t*/)[0] || '').length;
                const content = line.trim();

                // Handle #Note: as special text
                if (content.startsWith('#Note:')) {
                    const noteText = content.substring(6).trim();
                    stack[stack.length - 1].children.push({
                        type: 'note',
                        text: noteText,
                        level: level
                    });
                    continue;
                }

                // Check for fillable field (ends with _)
                const hasFillable = content.endsWith('_');
                const keepOnPage = content.endsWith('*');
                const title = content.replace(/[_*]+$/, '').trim();

                const item = {
                    title: title,
                    level: level,
                    type: 'checkbox',
                    children: [],
                    fillable: hasFillable,
                    keepOnPage: keepOnPage,
                    id: generateId(title)
                };

                // Maintain hierarchy stack
                while (stack.length > 0 && stack[stack.length - 1].level >= level) {
                    stack.pop();
                }

                stack[stack.length - 1].children.push(item);
                stack.push(item);
            }

            return root.children;
        }

        function generateId(text) {
            return text.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
        }

        function updateTemplateStatus() {
            const status = document.getElementById('template-status');
            if (template) {
                const itemCount = countItems(template);
                status.innerHTML = `<div id="template-info">✓ Template loaded (${itemCount} items)</div>`;
                document.getElementById('new-client-btn').disabled = false;
            } else {
                status.innerHTML = '';
                document.getElementById('new-client-btn').disabled = true;
            }
        }

        function countItems(items) {
            let count = 0;
            for (const item of items) {
                if (item.type === 'checkbox') count++;
                if (item.children) count += countItems(item.children);
            }
            return count;
        }

        // Client management
        function loadClients() {
            const stored = localStorage.getItem('clients');
            if (stored) {
                try {
                    clients = JSON.parse(stored);
                } catch (e) {
                    clients = [];
                }
            }
        }

        function saveClients() {
            localStorage.setItem('clients', JSON.stringify(clients));
        }

        function showNewClientModal() {
            if (!template) {
                alert('Please load a template first');
                return;
            }
            document.getElementById('new-client-modal').classList.add('active');
            document.getElementById('client-name-input').value = '';
            document.getElementById('case-number-input').value = '';
            document.getElementById('client-name-input').focus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function createClient() {
            const name = document.getElementById('client-name-input').value.trim();
            const caseNumber = document.getElementById('case-number-input').value.trim();

            if (!name) {
                alert('Please enter a client name');
                return;
            }

            const client = {
                id: Date.now().toString(),
                name: name,
                caseNumber: caseNumber,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                checklist: JSON.parse(JSON.stringify(template)),
                state: {} // Track checked items and field values
            };

            clients.push(client);
            saveClients();
            closeModal('new-client-modal');
            loadClient(client.id);
        }

        function showClientsScreen() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('clients-screen').style.display = 'block';
            document.getElementById('checklist-container').style.display = 'none';
            renderClientList();
        }

        function renderClientList() {
            const container = document.getElementById('client-list');
            const noClients = document.getElementById('no-clients');

            if (clients.length === 0) {
                container.innerHTML = '';
                noClients.style.display = 'block';
                return;
            }

            noClients.style.display = 'none';
            container.innerHTML = clients.map(client => {
                const progress = calculateProgress(client);
                return `
                    <div class="client-card" onclick="loadClient('${client.id}')">
                        <h3>${escapeHtml(client.name)}</h3>
                        ${client.caseNumber ? `<div style="font-size:12px;color:#666;">Case: ${escapeHtml(client.caseNumber)}</div>` : ''}
                        <div class="progress">${progress.completed} / ${progress.total} completed (${progress.percentage}%)</div>
                        <div style="font-size:12px;color:#999;">Modified: ${new Date(client.modified).toLocaleDateString()}</div>
                        <div class="actions">
                            <button onclick="event.stopPropagation(); exportClientById('${client.id}')">Export</button>
                            <button class="danger" onclick="event.stopPropagation(); deleteClient('${client.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateProgress(client) {
            let total = 0;
            let completed = 0;

            function count(items) {
                for (const item of items) {
                    if (item.type === 'checkbox') {
                        total++;
                        if (client.state[item.id]?.checked) {
                            completed++;
                        }
                    }
                    if (item.children) {
                        count(item.children);
                    }
                }
            }

            count(client.checklist);
            return {
                total,
                completed,
                percentage: total > 0 ? Math.round((completed / total) * 100) : 0
            };
        }

        function loadClient(clientId) {
            currentClient = clients.find(c => c.id === clientId);
            if (!currentClient) return;

            // Clear expanded items when switching clients
            expandedItems.clear();

            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('clients-screen').style.display = 'none';
            document.getElementById('checklist-container').style.display = 'block';

            document.getElementById('client-name').textContent =
                currentClient.name + (currentClient.caseNumber ? ` - ${currentClient.caseNumber}` : '');

            renderChecklist();
            updateOverallProgress();
        }

        function backToClients() {
            if (currentClient) {
                currentClient.modified = new Date().toISOString();
                saveClients();
            }
            currentClient = null;
            showClientsScreen();
        }

        function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client checklist?')) return;

            clients = clients.filter(c => c.id !== clientId);
            saveClients();
            renderClientList();
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-content');
            container.innerHTML = '';

            function renderItem(item, level = 0) {
                if (item.type === 'form') {
                    const formDiv = document.createElement('div');
                    formDiv.className = 'form-section';

                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'form-section-header';

                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'form-section-title';
                    titleSpan.textContent = item.title;

                    const printBtn = document.createElement('button');
                    printBtn.className = 'print-form-btn';
                    printBtn.textContent = '🖨️ Print Form';
                    printBtn.onclick = () => printForm(item);

                    headerDiv.appendChild(titleSpan);
                    headerDiv.appendChild(printBtn);

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'form-section-content';
                    contentDiv.textContent = item.content;

                    formDiv.appendChild(headerDiv);
                    formDiv.appendChild(contentDiv);
                    return formDiv;
                }

                if (item.type === 'note') {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'note';
                    noteDiv.textContent = item.text;
                    return noteDiv;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = `checklist-item level-${level}`;
                itemDiv.dataset.itemId = item.id;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'item-content';

                // Toggle icon for items with children
                if (item.children && item.children.length > 0) {
                    const toggle = document.createElement('span');
                    toggle.className = 'toggle-icon';
                    toggle.textContent = '▶'; // Start collapsed
                    toggle.onclick = () => toggleChildren(itemDiv);
                    contentDiv.appendChild(toggle);
                } else {
                    const spacer = document.createElement('span');
                    spacer.style.width = '20px';
                    spacer.style.display = 'inline-block';
                    contentDiv.appendChild(spacer);
                }

                // Checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = currentClient.state[item.id]?.checked || false;
                checkbox.onchange = () => handleCheckboxChange(item.id, checkbox.checked);
                contentDiv.appendChild(checkbox);

                // Title
                const titleSpan = document.createElement('span');
                titleSpan.className = 'item-text';
                if (checkbox.checked) titleSpan.classList.add('completed');
                titleSpan.textContent = item.title;
                titleSpan.onclick = () => checkbox.click();

                // Add progress indicator for items with children
                if (item.children && item.children.length > 0) {
                    const progress = getItemProgress(item);
                    const progressSpan = document.createElement('span');
                    progressSpan.className = 'item-progress';
                    progressSpan.textContent = `(${progress.completed}/${progress.total})`;
                    titleSpan.appendChild(progressSpan);
                }

                contentDiv.appendChild(titleSpan);

                // Add print button for items with children
                if (item.children && item.children.length > 0) {
                    const printBtn = document.createElement('button');
                    printBtn.className = 'print-section-btn';
                    printBtn.textContent = '🖨️';
                    printBtn.title = 'Print this section';
                    printBtn.onclick = (e) => {
                        e.stopPropagation();
                        printSection(item);
                    };
                    contentDiv.appendChild(printBtn);
                }

                itemDiv.appendChild(contentDiv);

                // Children
                if (item.children && item.children.length > 0) {
                    const childrenDiv = document.createElement('div');
                    // Check if this item should be expanded
                    const isExpanded = expandedItems.has(item.id);
                    childrenDiv.className = isExpanded ? 'children' : 'children children-collapsed';

                    // Update toggle icon to match state
                    const toggleIcon = itemDiv.querySelector('.toggle-icon');
                    if (toggleIcon) {
                        toggleIcon.textContent = isExpanded ? '▼' : '▶';
                    }

                    for (const child of item.children) {
                        const childElement = renderItem(child, level + 1);
                        if (childElement) childrenDiv.appendChild(childElement);
                    }
                    itemDiv.appendChild(childrenDiv);
                }

                return itemDiv;
            }

            for (const item of currentClient.checklist) {
                const element = renderItem(item, 0);
                if (element) container.appendChild(element);
            }
        }

        function toggleChildren(itemDiv) {
            const children = itemDiv.querySelector('.children');
            const toggle = itemDiv.querySelector('.toggle-icon');
            if (!children || !toggle) return;

            const itemId = itemDiv.dataset.itemId;

            if (children.classList.contains('children-collapsed')) {
                children.classList.remove('children-collapsed');
                toggle.textContent = '▼';
                expandedItems.add(itemId);
            } else {
                children.classList.add('children-collapsed');
                toggle.textContent = '▶';
                expandedItems.delete(itemId);
            }
        }

        function handleCheckboxChange(itemId, checked) {
            if (!currentClient.state[itemId]) {
                currentClient.state[itemId] = {};
            }
            currentClient.state[itemId].checked = checked;

            // Update parent checkboxes
            updateParentCheckboxes();
            updateOverallProgress();
            saveChecklist();

            // Re-render to update styling and progress
            renderChecklist();
        }

        function updateParentCheckboxes() {
            function checkParent(item) {
                if (!item.children || item.children.length === 0) return;

                let allChecked = true;
                for (const child of item.children) {
                    if (child.type === 'checkbox') {
                        if (!currentClient.state[child.id]?.checked) {
                            allChecked = false;
                        }
                    }
                    checkParent(child);
                }

                // Auto-check parent if all children are checked
                if (allChecked && item.type === 'checkbox') {
                    if (!currentClient.state[item.id]) {
                        currentClient.state[item.id] = {};
                    }
                    currentClient.state[item.id].checked = true;
                }
            }

            for (const item of currentClient.checklist) {
                checkParent(item);
            }
        }

        function getItemProgress(item) {
            let total = 0;
            let completed = 0;

            function count(items) {
                for (const child of items) {
                    if (child.type === 'checkbox') {
                        total++;
                        if (currentClient.state[child.id]?.checked) {
                            completed++;
                        }
                    }
                    if (child.children) {
                        count(child.children);
                    }
                }
            }

            if (item.children) count(item.children);
            return { total, completed };
        }

        function updateOverallProgress() {
            const progress = calculateProgress(currentClient);
            const progressDiv = document.getElementById('overall-progress');
            progressDiv.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                </div>
                <div style="font-size: 14px; color: #666;">
                    ${progress.completed} / ${progress.total} items completed (${progress.percentage}%)
                </div>
            `;
        }

        function saveChecklist() {
            if (!currentClient) return;
            currentClient.modified = new Date().toISOString();
            saveClients();
        }

        function searchChecklist(query) {
            if (!query.trim()) {
                // Show all items
                document.querySelectorAll('.checklist-item').forEach(item => {
                    item.style.display = '';
                });
                return;
            }

            const lowerQuery = query.toLowerCase();
            document.querySelectorAll('.checklist-item').forEach(item => {
                const text = item.querySelector('.item-text')?.textContent.toLowerCase() || '';
                if (text.includes(lowerQuery)) {
                    item.style.display = '';
                    // Show parents
                    let parent = item.parentElement;
                    while (parent) {
                        if (parent.classList.contains('children')) {
                            parent.classList.remove('children-collapsed');
                        }
                        parent = parent.parentElement;
                    }
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function exportClient() {
            if (!currentClient) return;
            exportClientById(currentClient.id);
        }

        function exportClientById(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            // Ask if user wants encryption
            if (confirm('Do you want to encrypt this backup with a password?\n\n⚠️ If you lose the password, the backup cannot be recovered.\n\nClick OK for encrypted backup, Cancel for unencrypted.')) {
                pendingExportData = {
                    type: 'single',
                    data: client,
                    filename: `${client.name.replace(/[^a-z0-9]/gi, '_')}_checklist_ENCRYPTED.json`
                };
                showEncryptionModal();
            } else {
                // Export unencrypted
                const data = JSON.stringify(client, null, 2);
                downloadFile(data, `${client.name.replace(/[^a-z0-9]/gi, '_')}_checklist.json`);
            }
        }

        function showImportModal() {
            document.getElementById('import-modal').classList.add('active');
        }

        function importClient() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);

                    // Check if encrypted
                    if (parsed.encrypted && parsed.version) {
                        pendingImportData = parsed;
                        pendingImportType = 'single';
                        closeModal('import-modal');
                        showDecryptionModal();
                        return;
                    }

                    // Unencrypted import
                    const client = parsed;

                    // Validate client data
                    if (!client.name || !client.checklist) {
                        throw new Error('Invalid client data');
                    }

                    // Generate new ID to avoid conflicts
                    client.id = Date.now().toString();
                    client.modified = new Date().toISOString();

                    clients.push(client);
                    saveClients();
                    closeModal('import-modal');
                    showClientsScreen();
                    alert('Client imported successfully!');
                } catch (error) {
                    alert('Error importing client: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportAllClients() {
            if (clients.length === 0) {
                alert('No clients to export');
                return;
            }

            const timestamp = new Date().toISOString().split('T')[0];

            // Ask if user wants encryption
            if (confirm('Do you want to encrypt this backup with a password?\n\n⚠️ If you lose the password, the backup cannot be recovered.\n\nClick OK for encrypted backup, Cancel for unencrypted.')) {
                pendingExportData = {
                    type: 'all',
                    data: clients,
                    filename: `all_clients_backup_ENCRYPTED_${timestamp}.json`
                };
                showEncryptionModal();
            } else {
                // Export unencrypted
                const data = JSON.stringify(clients, null, 2);
                downloadFile(data, `all_clients_backup_${timestamp}.json`);
                alert(`Exported ${clients.length} client(s) successfully!`);
            }
        }

        function downloadFile(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showImportAllModal() {
            document.getElementById('import-all-modal').classList.add('active');
        }

        function importAllClients() {
            const fileInput = document.getElementById('import-all-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!confirm('This will REPLACE all existing clients. Are you sure?')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);

                    // Check if encrypted
                    if (parsed.encrypted && parsed.version) {
                        pendingImportData = parsed;
                        pendingImportType = 'all';
                        closeModal('import-all-modal');
                        showDecryptionModal();
                        return;
                    }

                    // Unencrypted import
                    const importedClients = parsed;

                    // Validate it's an array
                    if (!Array.isArray(importedClients)) {
                        throw new Error('Invalid backup file format (expected array)');
                    }

                    // Validate each client
                    for (const client of importedClients) {
                        if (!client.name || !client.checklist) {
                            throw new Error('Invalid client data in backup file');
                        }
                    }

                    // Replace all clients
                    clients = importedClients;
                    saveClients();
                    closeModal('import-all-modal');
                    showClientsScreen();
                    alert(`Successfully imported ${clients.length} client(s)!`);
                } catch (error) {
                    alert('Error importing clients: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function printChecklist() {
            // Print entire checklist (all items expanded)
            let allSectionsHtml = '';

            function buildSectionHtml(item, level = 0) {
                let html = '';
                const indent = level * 30; // 30px per level

                if (item.type === 'note') {
                    html += `<div style="margin-left: ${indent}px; font-style: italic; color: #666; margin: 8px 0;">${escapeHtml(item.text)}</div>`;
                    return html;
                }

                if (item.type === 'form') {
                    html += `<div style="margin-left: ${indent}px; background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 3px solid #3498db;">`;
                    html += `<div style="font-weight: bold; margin-bottom: 8px;">${escapeHtml(item.title)}</div>`;
                    html += `<div style="font-family: monospace; font-size: 10pt; white-space: pre-wrap;">${escapeHtml(item.content)}</div>`;
                    html += `</div>`;
                    return html;
                }

                if (item.type === 'checkbox') {
                    const isChecked = currentClient.state[item.id]?.checked || false;
                    const checkbox = isChecked ? '☑' : '☐';
                    const textDecoration = isChecked ? 'text-decoration: line-through; color: #999;' : '';

                    html += `<div style="margin-left: ${indent}px; margin: 6px 0; display: flex; align-items: baseline;">`;
                    html += `<span style="margin-right: 8px; font-size: 14pt;">${checkbox}</span>`;
                    html += `<span style="${textDecoration}">${escapeHtml(item.title)}</span>`;
                    html += `</div>`;

                    // Recursively add children
                    if (item.children && item.children.length > 0) {
                        for (const child of item.children) {
                            html += buildSectionHtml(child, level + 1);
                        }
                    }
                }

                return html;
            }

            // Build HTML for all top-level items
            for (const item of currentClient.checklist) {
                allSectionsHtml += buildSectionHtml(item);
            }

            // Create printable window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Complete Checklist - ${escapeHtml(currentClient.name)}</title>
    <style>
        @page {
            size: letter;
            margin: 0.75in;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
        }

        .section-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }

        .section-header h1 {
            font-size: 18pt;
            margin-bottom: 5px;
        }

        .section-header .org {
            font-size: 10pt;
            color: #333;
        }

        .client-info {
            margin-bottom: 20px;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ccc;
        }

        .client-info strong {
            display: inline-block;
            width: 100px;
        }

        .print-instructions {
            background: #fffacd;
            border: 1px solid #f0e68c;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 10pt;
        }

        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="section-header">
        <h1>Complete Criminal Defense Checklist</h1>
        <div class="org">Institute for Advanced Criminal Law Studies</div>
        <div class="org" style="font-size: 9pt;">IACLS.ORG</div>
    </div>

    <div class="client-info">
        <div><strong>Client:</strong> ${escapeHtml(currentClient.name)}</div>
        ${currentClient.caseNumber ? `<div><strong>Case Number:</strong> ${escapeHtml(currentClient.caseNumber)}</div>` : ''}
        <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
    </div>

    <div class="print-instructions no-print">
        <strong>Instructions:</strong> Use your browser's Print function (Ctrl/Cmd+P) and select "Save as PDF" to save the complete checklist.
        <button onclick="window.print()" style="margin-left: 20px; padding: 5px 15px;">🖨️ Print / Save as PDF</button>
    </div>

    <div class="section-content">
        ${allSectionsHtml}
    </div>
</body>
</html>
            `);
            printWindow.document.close();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function printSection(item) {
            // Recursively build HTML for item and all descendants
            function buildSectionHtml(item, level = 0) {
                let html = '';
                const indent = level * 30; // 30px per level

                if (item.type === 'note') {
                    html += `<div style="margin-left: ${indent}px; font-style: italic; color: #666; margin: 8px 0;">${escapeHtml(item.text)}</div>`;
                    return html;
                }

                if (item.type === 'form') {
                    html += `<div style="margin-left: ${indent}px; background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 3px solid #3498db;">`;
                    html += `<div style="font-weight: bold; margin-bottom: 8px;">${escapeHtml(item.title)}</div>`;
                    html += `<div style="font-family: monospace; font-size: 10pt; white-space: pre-wrap;">${escapeHtml(item.content)}</div>`;
                    html += `</div>`;
                    return html;
                }

                if (item.type === 'checkbox') {
                    const isChecked = currentClient.state[item.id]?.checked || false;
                    const checkbox = isChecked ? '☑' : '☐';
                    const textDecoration = isChecked ? 'text-decoration: line-through; color: #999;' : '';

                    html += `<div style="margin-left: ${indent}px; margin: 6px 0; display: flex; align-items: baseline;">`;
                    html += `<span style="margin-right: 8px; font-size: 14pt;">${checkbox}</span>`;
                    html += `<span style="${textDecoration}">${escapeHtml(item.title)}</span>`;
                    html += `</div>`;

                    // Recursively add children
                    if (item.children && item.children.length > 0) {
                        for (const child of item.children) {
                            html += buildSectionHtml(child, level + 1);
                        }
                    }
                }

                return html;
            }

            const sectionHtml = buildSectionHtml(item);

            // Create printable window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${escapeHtml(item.title)} - ${escapeHtml(currentClient.name)}</title>
    <style>
        @page {
            size: letter;
            margin: 0.75in;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
        }

        .section-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }

        .section-header h1 {
            font-size: 18pt;
            margin-bottom: 5px;
        }

        .section-header .org {
            font-size: 10pt;
            color: #333;
        }

        .client-info {
            margin-bottom: 20px;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ccc;
        }

        .client-info strong {
            display: inline-block;
            width: 100px;
        }

        .print-instructions {
            background: #fffacd;
            border: 1px solid #f0e68c;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 10pt;
        }

        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="section-header">
        <h1>${escapeHtml(item.title)}</h1>
        <div class="org">Institute for Advanced Criminal Law Studies</div>
        <div class="org" style="font-size: 9pt;">IACLS.ORG</div>
    </div>

    <div class="client-info">
        <div><strong>Client:</strong> ${escapeHtml(currentClient.name)}</div>
        ${currentClient.caseNumber ? `<div><strong>Case Number:</strong> ${escapeHtml(currentClient.caseNumber)}</div>` : ''}
        <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
    </div>

    <div class="print-instructions no-print">
        <strong>Instructions:</strong> Use your browser's Print function (Ctrl/Cmd+P) and select "Save as PDF" to save this section.
        <button onclick="window.print()" style="margin-left: 20px; padding: 5px 15px;">🖨️ Print / Save as PDF</button>
    </div>

    <div class="section-content">
        ${sectionHtml}
    </div>
</body>
</html>
            `);
            printWindow.document.close();
        }

        function printForm(formItem) {
            // Parse form content to identify fillable fields
            const lines = formItem.content.split('\n');
            let formHtml = '';

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) {
                    formHtml += '<br>';
                    continue;
                }

                // Check if line has fillable field (ends with _)
                if (trimmed.endsWith('_')) {
                    const label = trimmed.slice(0, -1).trim();
                    if (label.includes(':')) {
                        // Format: "Label: _" -> "Label: __________"
                        const parts = label.split(':');
                        formHtml += `<div class="form-field"><span class="field-label">${escapeHtml(parts[0])}:</span><span class="field-line"></span></div>`;
                    } else if (label) {
                        // Format: "Label_" -> "Label __________"
                        formHtml += `<div class="form-field"><span class="field-label">${escapeHtml(label)}</span><span class="field-line"></span></div>`;
                    } else {
                        // Format: "_" -> full width line
                        formHtml += `<div class="form-field-full"><span class="field-line-full"></span></div>`;
                    }
                } else if (trimmed.endsWith('__')) {
                    // Double underscore = multiline field
                    const label = trimmed.slice(0, -2).trim();
                    formHtml += `<div class="form-field"><span class="field-label">${escapeHtml(label)}</span></div>`;
                    formHtml += `<div class="form-field-multiline"></div>`;
                } else {
                    // Regular text
                    formHtml += `<div class="form-text">${escapeHtml(trimmed)}</div>`;
                }
            }

            // Create printable form window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${escapeHtml(formItem.title)} - ${escapeHtml(currentClient.name)}</title>
    <style>
        @page {
            size: letter;
            margin: 0.75in;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #000;
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }

        .form-header h1 {
            font-size: 18pt;
            margin-bottom: 5px;
        }

        .form-header .org {
            font-size: 10pt;
            color: #333;
        }

        .client-info {
            margin-bottom: 20px;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ccc;
        }

        .client-info strong {
            display: inline-block;
            width: 100px;
        }

        .form-text {
            margin: 8px 0;
        }

        .form-field {
            display: flex;
            align-items: baseline;
            margin: 12px 0;
            page-break-inside: avoid;
        }

        .field-label {
            margin-right: 8px;
            white-space: nowrap;
        }

        .field-line {
            flex: 1;
            border-bottom: 1px solid #000;
            min-width: 200px;
            height: 12px;
        }

        .form-field-full {
            margin: 12px 0;
        }

        .field-line-full {
            display: block;
            border-bottom: 1px solid #000;
            height: 12px;
            width: 100%;
        }

        .form-field-multiline {
            border: 1px solid #000;
            min-height: 80px;
            margin: 8px 0 16px 20px;
            page-break-inside: avoid;
        }

        @media print {
            .no-print {
                display: none;
            }
        }

        .print-instructions {
            background: #fffacd;
            border: 1px solid #f0e68c;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 10pt;
        }
    </style>
</head>
<body>
    <div class="form-header">
        <h1>${escapeHtml(formItem.title)}</h1>
        <div class="org">Institute for Advanced Criminal Law Studies</div>
        <div class="org" style="font-size: 9pt;">IACLS.ORG</div>
    </div>

    <div class="client-info">
        <div><strong>Client:</strong> ${escapeHtml(currentClient.name)}</div>
        ${currentClient.caseNumber ? `<div><strong>Case Number:</strong> ${escapeHtml(currentClient.caseNumber)}</div>` : ''}
        <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
    </div>

    <div class="print-instructions no-print">
        <strong>Instructions:</strong> Use your browser's Print function (Ctrl/Cmd+P) and select "Save as PDF" to create a fillable PDF form.
        <button onclick="window.print()" style="margin-left: 20px; padding: 5px 15px;">🖨️ Print / Save as PDF</button>
    </div>

    <div class="form-content">
        ${formHtml}
    </div>
</body>
</html>
            `);
            printWindow.document.close();
        }

        // Encryption/Decryption functions
        async function encryptData(data, password) {
            const encoder = new TextEncoder();
            const dataBuffer = encoder.encode(JSON.stringify(data));

            // Derive key from password using PBKDF2
            const passwordBuffer = encoder.encode(password);
            const importedKey = await crypto.subtle.importKey(
                'raw',
                passwordBuffer,
                { name: 'PBKDF2' },
                false,
                ['deriveBits', 'deriveKey']
            );

            // Generate a random salt
            const salt = crypto.getRandomValues(new Uint8Array(16));

            // Derive encryption key
            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                importedKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt']
            );

            // Generate random IV
            const iv = crypto.getRandomValues(new Uint8Array(12));

            // Encrypt the data
            const encryptedBuffer = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                dataBuffer
            );

            // Combine salt + iv + encrypted data
            const result = new Uint8Array(salt.length + iv.length + encryptedBuffer.byteLength);
            result.set(salt, 0);
            result.set(iv, salt.length);
            result.set(new Uint8Array(encryptedBuffer), salt.length + iv.length);

            // Convert to base64
            const base64 = btoa(String.fromCharCode(...result));

            return {
                encrypted: true,
                version: 1,
                data: base64
            };
        }

        async function decryptData(encryptedObj, password) {
            const encoder = new TextEncoder();
            const decoder = new TextDecoder();

            // Decode base64
            const combined = Uint8Array.from(atob(encryptedObj.data), c => c.charCodeAt(0));

            // Extract salt, IV, and encrypted data
            const salt = combined.slice(0, 16);
            const iv = combined.slice(16, 28);
            const encryptedData = combined.slice(28);

            // Derive key from password
            const passwordBuffer = encoder.encode(password);
            const importedKey = await crypto.subtle.importKey(
                'raw',
                passwordBuffer,
                { name: 'PBKDF2' },
                false,
                ['deriveBits', 'deriveKey']
            );

            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                importedKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );

            // Decrypt
            const decryptedBuffer = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                encryptedData
            );

            const decryptedText = decoder.decode(decryptedBuffer);
            return JSON.parse(decryptedText);
        }

        function showEncryptionModal() {
            document.getElementById('export-password').value = '';
            document.getElementById('export-password-confirm').value = '';
            document.getElementById('export-encryption-modal').classList.add('active');
            document.getElementById('export-password').focus();
        }

        async function confirmEncryptedExport() {
            const password = document.getElementById('export-password').value;
            const confirmPassword = document.getElementById('export-password-confirm').value;

            if (!password) {
                alert('Please enter a password');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (password.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }

            try {
                const encrypted = await encryptData(pendingExportData.data, password);
                const data = JSON.stringify(encrypted, null, 2);
                downloadFile(data, pendingExportData.filename);

                const isAll = pendingExportData.type === 'all';
                closeModal('export-encryption-modal');
                pendingExportData = null;

                if (isAll) {
                    alert(`Exported and encrypted ${clients.length} client(s) successfully!`);
                } else {
                    alert('Client exported and encrypted successfully!');
                }
            } catch (error) {
                alert('Encryption failed: ' + error.message);
            }
        }

        async function attemptDecryption(encryptedObj, password, isAll) {
            try {
                const decryptedData = await decryptData(encryptedObj, password);

                if (isAll) {
                    // Validate it's an array
                    if (!Array.isArray(decryptedData)) {
                        throw new Error('Invalid backup file format');
                    }

                    // Replace all clients
                    clients = decryptedData;
                    saveClients();
                    alert(`Successfully imported ${clients.length} client(s)!`);
                } else {
                    // Single client
                    if (!decryptedData.name || !decryptedData.checklist) {
                        throw new Error('Invalid client data');
                    }

                    // Generate new ID
                    decryptedData.id = Date.now().toString();
                    decryptedData.modified = new Date().toISOString();

                    clients.push(decryptedData);
                    saveClients();
                    alert('Client imported successfully!');
                }

                closeModal('import-decryption-modal');
                showClientsScreen();
                pendingImportData = null;
                pendingImportType = null;
            } catch (error) {
                alert('Decryption failed. Wrong password or corrupted file.');
            }
        }

        function showDecryptionModal() {
            document.getElementById('import-password').value = '';
            document.getElementById('import-decryption-modal').classList.add('active');
            document.getElementById('import-password').focus();
        }

        function confirmDecryptedImport() {
            const password = document.getElementById('import-password').value;

            if (!password) {
                alert('Please enter the decryption password');
                return;
            }

            attemptDecryption(pendingImportData, password, pendingImportType === 'all');
        }

        // Theme management
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                updateThemeButton();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeButton();
        }

        function updateThemeButton() {
            const button = document.getElementById('theme-toggle');
            const isDark = document.body.classList.contains('dark-theme');
            button.textContent = isDark ? '☀️ Light' : '🌙 Dark';
        }

        // Clear local storage
        function clearLocalStorage() {
            const clientCount = clients.length;

            if (clientCount === 0) {
                if (confirm('Clear all application data including template cache and theme preference?')) {
                    localStorage.clear();
                    alert('Local storage cleared. Reloading page...');
                    location.reload();
                }
                return;
            }

            // Warn about backing up first
            const message = `⚠️ WARNING: You have ${clientCount} client(s) stored locally.\n\n` +
                `Before clearing, you should:\n` +
                `1. Click "📦 Export All" to backup your data\n` +
                `2. Save the backup file securely\n\n` +
                `Clearing will permanently delete:\n` +
                `- All ${clientCount} client checklist(s)\n` +
                `- Template cache\n` +
                `- Theme preference\n\n` +
                `Have you backed up your data?\n\n` +
                `Click OK to proceed with clearing (CANNOT BE UNDONE)\n` +
                `Click Cancel to go back and export first`;

            if (confirm(message)) {
                // Double confirmation
                if (confirm(`FINAL CONFIRMATION: Delete all ${clientCount} client(s) permanently?`)) {
                    localStorage.clear();
                    clients = [];
                    template = null;
                    alert('Local storage cleared. Reloading page...');
                    location.reload();
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (currentClient) {
                    saveChecklist();
                    alert('Checklist saved!');
                }
            }
        });
    </script>

    <footer>
        <p>
            Developed by the <a href="https://iacls.org" target="_blank">Institute for Advanced Criminal Law Studies</a>
        </p>
        <p style="font-size: 12px; margin-top: 10px;">
            © 2025 IACLS.ORG | <a href="https://iacls.org" target="_blank">Visit IACLS.org</a>
        </p>
    </footer>
</body>
</html>
