<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive criminal defense checklist manager by the Institute for Advanced Criminal Law Studies - Paginated Version">
    <meta name="author" content="Institute for Advanced Criminal Law Studies">
    <title>Criminal-Defense Checklist | IACLS.org</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20standalone%3D%22no%22%3F%3E%0A%3C%21DOCTYPE%20svg%20PUBLIC%20%22-//W3C//DTD%20SVG%2020010904//EN%22%0A%20%22http%3A//www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd%22%3E%0A%3Csvg%20version%3D%221.0%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%0A%20width%3D%22600.000000pt%22%20height%3D%22600.000000pt%22%20viewBox%3D%220%200%20600.000000%20600.000000%22%0A%20preserveAspectRatio%3D%22xMidYMid%20meet%22%3E%0A%3Cmetadata%3E%0ACreated%20by%20potrace%201.16%2C%20written%20by%20Peter%20Selinger%202001-2019%0A%3C/metadata%3E%0A%3Cg%20transform%3D%22translate%280.000000%2C600.000000%29%20scale%280.100000%2C-0.100000%29%22%0Afill%3D%22%23000000%22%20stroke%3D%22none%22%3E%0A%3Cpath%20d%3D%22M0%203000%20l0%20-3000%203000%200%203000%200%200%203000%200%203000%20-3000%200%20-3000%200%200%0A-3000z%20m1257%202299%20c462%20-119%20684%20-199%201008%20-364%20397%20-203%20739%20-449%201046%20-755%0A177%20-176%20305%20-329%20381%20-456%2052%20-88%20146%20-272%20178%20-349%2020%20-49%2018%20-47%20-102%2080%0A-549%20584%20-935%20920%20-1213%201056%20-71%2035%20-76%2036%20-45%2012%20274%20-218%20571%20-486%20820%0A-739%20200%20-204%20490%20-519%20498%20-544%202%20-5%20-10%20-16%20-26%20-24%20-27%20-14%20-31%20-14%20-47%204%0A-30%2034%20-118%2068%20-215%2084%20-199%2034%20-265%2048%20-324%2067%20-72%2024%20-181%2088%20-169%2099%204%204%0A37%2012%2073%2017%2036%206%2094%2024%20130%2040%20l65%2030%20-115%207%20c-378%2024%20-620%20117%20-915%20352%20-49%0A39%20-107%2089%20-128%20111%20l-38%2040%2089%206%20c98%206%20198%2029%20252%2057%20l35%2019%20-131%201%20c-212%200%0A-326%2033%20-463%20133%20-60%2043%20-234%20216%20-252%20249%20-10%2019%20-9%2020%2012%2014%2048%20-15%20312%20-19%0A412%20-6%2054%207%2096%2014%2094%2016%20-2%202%20-66%2013%20-143%2024%20-308%2043%20-414%2077%20-554%20181%20-103%0A75%20-252%20276%20-351%20471%20-39%2078%20-47%20108%20-29%20108%205%200%2081%20-18%20167%20-41z%20m3014%20-1872%0Ac19%20-12%2043%20-39%2054%20-59%2018%20-33%2018%20-39%205%20-67%20-28%20-59%20-114%20-161%20-130%20-154%20-8%203%0A-61%2021%20-117%2040%20-57%2019%20-103%2038%20-103%2042%200%204%2031%2045%2068%2092%20105%20130%20154%20153%20223%0A106z%20m203%20-216%20c68%20-45%2083%20-111%2039%20-170%20-78%20-105%20-258%20-323%20-273%20-331%20-49%20-26%0A-108%206%20-97%2052%205%2019%2017%2026%2063%2036%20123%2025%20185%2094%20188%20207%201%2063%20-18%2090%20-77%20106%0Al-39%2010%2023%2027%20c70%2080%2072%2082%20108%2082%2020%200%2049%20-9%2065%20-19z%20m-400%20-106%20c72%20-24%20150%0A-49%20174%20-55%2077%20-20%2090%20-80%2029%20-139%20-39%20-39%20-116%20-56%20-212%20-47%20-38%204%20-79%208%20-90%0A8%20-22%200%20-135%20-44%20-135%20-53%200%20-3%2030%20-11%2067%20-17%2074%20-12%2087%20-23%20104%20-87%2020%20-72%205%0A-160%20-44%20-258%20l-45%20-87%2037%2021%20c55%2034%2089%2068%20129%20132%2033%2054%2038%2058%2065%2053%2032%20-7%0A95%20-54%20192%20-144%20l63%20-60%20-62%20-78%20c-113%20-143%20-177%20-187%20-301%20-210%20-85%20-16%20-92%0A-20%20-144%20-68%20-47%20-44%20-393%20-425%20-475%20-523%20-80%20-95%20-373%20-319%20-521%20-398%20-44%0A-24%20-58%20-26%20-115%20-21%20-58%205%20-95%2020%20-340%20142%20-393%20194%20-611%20329%20-752%20465%20-89%0A85%20-62%20137%20143%20281%2092%2065%20172%20155%20201%20225%2020%2051%2023%2074%2023%20198%200%20125%20-3%20151%0A-29%20238%20-16%2053%20-26%20100%20-23%20103%2010%2011%2074%20-16%20139%20-58%2092%20-59%20200%20-150%20303%0A-253%2074%20-73%2099%20-106%20133%20-175%2022%20-47%2045%20-104%2051%20-128%209%20-42%208%20-45%20-36%20-100%0A-25%20-31%20-51%20-63%20-57%20-71%20-20%20-26%2033%20-2%20189%2084%2083%2045%20179%2097%20215%20114%20132%2066%0A409%20263%20503%20358%20l58%2059%2015%20120%20c32%20246%2050%20305%20101%20342%2083%2058%20242%20130%20292%20131%0A13%201%2083%20-19%20155%20-44z%20m575%20-140%20c22%20-25%2031%20-46%2031%20-71%200%20-31%20-13%20-48%20-125%0A-163%20-141%20-144%20-180%20-171%20-219%20-153%20-15%206%20-32%2023%20-38%2037%20-10%2023%20-7%2032%2032%2088%0A70%2099%20186%20242%20220%20270%2042%2036%2062%2034%2099%20-8z%20m90%20-213%20c46%20-66%2035%20-110%20-46%20-182%0A-66%20-58%20-141%20-100%20-180%20-100%20-39%200%20-77%2032%20-68%2059%2010%2031%20231%20251%20253%20251%2011%200%0A30%20-13%2041%20-28z%20m15%20-477%20c107%20-161%20129%20-198%20112%20-188%20-49%2028%20-326%20287%20-315%0A296%202%202%2022%2016%2044%2030%20l39%2027%2023%20-28%20c13%20-15%2056%20-76%2097%20-137z%20m-1725%20-1472%20c1%0A-17%20-3%20-35%20-9%20-38%20-5%20-3%20-10%202%20-10%2013%200%2027%20-44%2065%20-76%2065%20-27%200%20-64%20-33%20-64%0A-57%200%20-24%2033%20-57%20100%20-100%2038%20-25%2076%20-56%2085%20-70%2025%20-37%2021%20-118%20-6%20-163%20-37%0A-60%20-134%20-90%20-205%20-63%20-20%208%20-29%208%20-34%20-1%20-12%20-19%20-20%205%20-26%2078%20l-4%2068%2019%20-42%0Ac21%20-45%2071%20-83%20109%20-83%2030%200%2078%2025%2086%2045%203%209%206%2030%206%2047%200%2034%20-42%2081%20-123%20135%0A-50%2034%20-67%2064%20-67%20114%200%2076%2059%20125%20142%20117%2029%20-3%2051%20-1%2055%206%209%2013%2021%20-26%2022%0A-71z%20m1629%20-7%20c3%20-73%20-10%20-87%20-28%20-31%20-16%2048%20-44%2065%20-108%2065%20-63%200%20-98%20-16%0A-140%20-64%20-71%20-82%20-49%20-252%2043%20-322%2037%20-28%20104%20-41%20150%20-30%2025%206%2026%208%2023%2078%20-3%0A69%20-5%2073%20-35%2094%20l-31%2021%20100%200%20c56%20-1%2095%20-3%2087%20-5%20-28%20-8%20-39%20-37%20-39%20-97%200%0A-52%20-4%20-65%20-23%20-83%20-72%20-68%20-221%20-51%20-315%2033%20-119%20107%20-108%20261%2026%20358%2055%2040%0A121%2056%20212%2052%20l75%20-4%203%20-65z%20m-3055%2054%20c-40%20-16%20-46%20-46%20-51%20-236%20-5%20-199%20-1%0A-214%2058%20-214%2026%200%2031%207%2060%2077%2032%2076%20104%20262%20131%20338%208%2022%2019%2040%2023%2040%205%200%2034%0A-67%2066%20-150%2065%20-170%2097%20-238%20135%20-284%20l27%20-31%20-94%201%20c-74%200%20-88%203%20-70%2011%2028%0A14%2028%2034%20-2%20103%20l-25%2055%20-55%200%20-54%200%20-21%20-62%20c-26%20-75%20-26%20-95%20-3%20-101%209%20-3%0A-55%20-5%20-143%20-6%20-88%200%20-155%203%20-148%207%2024%2015%2032%2063%2039%20237%20l7%20178%20-29%2024%20-29%2023%0A100%20-1%20c68%200%2093%20-3%2078%20-9z%20m787%20-47%20c0%20-54%20-13%20-70%20-25%20-32%20-10%2029%20-64%2059%0A-108%2059%20-97%200%20-167%20-87%20-167%20-208%200%20-169%20158%20-253%20273%20-144%2030%2029%2031%2028%2016%0A-31%20-10%20-43%20-10%20-43%20-74%20-55%20-138%20-26%20-204%20-6%20-262%2081%20-80%20120%20-37%20298%2088%20361%0A50%2025%2062%2027%20156%2024%20l103%20-3%200%20-52z%20m186%2035%20c-13%20-18%20-16%20-56%20-16%20-210%200%20-214%0A-2%20-208%2088%20-208%2035%200%2057%206%2075%2020%20l26%2021%20-13%20-38%20c-7%20-21%20-18%20-38%20-25%20-37%20-6%201%0A-68%202%20-137%203%20-114%201%20-125%203%20-113%2017%209%2011%2015%2077%2021%20217%209%20200%209%20202%20-13%20220%0A-21%2017%20-19%2017%2050%2017%20l72%200%20-15%20-22z%20m1145%20-6%20c34%20-17%2065%20-44%2084%20-71%2028%20-40%2030%0A-49%2030%20-130%200%20-80%20-3%20-92%20-30%20-137%20-77%20-123%20-275%20-147%20-387%20-46%20-82%2074%20-105%0A180%20-59%20275%2060%20123%20235%20176%20362%20109z%20m431%20-10%20c40%20-24%2064%20-89%2048%20-136%20-11%20-33%0A-53%20-79%20-82%20-88%20-19%20-7%2067%20-144%20132%20-209%2063%20-64%20131%20-102%20222%20-125%2074%20-19%20130%0A-14%20206%2021%2069%2031%2082%2032%2052%200%20-49%20-52%20-186%20-76%20-294%20-51%20-139%2033%20-254%20117%20-354%0A259%20-30%2043%20-63%2084%20-73%2090%20-28%2017%20-23%2027%2011%2027%2071%200%20119%2056%20106%20123%20-9%2050%20-46%0A79%20-105%2085%20-48%204%20-50%203%20-57%20-23%20-4%20-15%20-5%20-106%20-2%20-202%205%20-171%206%20-176%2029%20-194%0A24%20-18%2024%20-19%20-59%20-19%20l-83%200%2015%2022%20c13%2019%2016%2058%2016%20223%200%20147%20-3%20205%20-12%20214%0A-20%2021%20246%206%20284%20-17z%20m-916%20-347%20c24%20-24%2025%20-28%2011%20-48%20-18%20-28%20-53%20-33%20-78%0A-11%20-25%2023%20-24%2049%203%2068%2030%2021%2035%2020%2064%20-9z%22/%3E%0A%3Cpath%20d%3D%22M1787%20665%20c-22%20-65%20-22%20-65%2018%20-65%2040%200%2042%206%2016%2069%20l-18%2044%20-16%20-48z%22/%3E%0A%3Cpath%20d%3D%22M3500%20811%20c-20%20-10%20-44%20-36%20-58%20-62%20-32%20-59%20-27%20-153%2012%20-233%2033%20-67%0A70%20-95%20133%20-102%2062%20-7%20128%2026%20155%2076%2023%2044%2024%20135%201%20192%20-48%20127%20-149%20180%0A-243%20129z%22/%3E%0A%3C/g%3E%0A%3C/svg%3E%0A">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            transition: background 0.3s, color 0.3s;
        }

        /* Dark theme */
        body.dark-theme {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-theme .card {
            background: #2d2d2d;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        body.dark-theme header {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
        }

        body.dark-theme .client-card {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        body.dark-theme .client-card:hover {
            background: #4a4a4a;
        }

        body.dark-theme .section-link {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        body.dark-theme .section-link:hover {
            background: #4a4a4a;
        }

        body.dark-theme .breadcrumb {
            background: #2a2a2a;
        }

        body.dark-theme .breadcrumb a {
            color: #5dade2;
        }

        body.dark-theme .form-section {
            background: #2a2a2a;
            border-left-color: #3498db;
        }

        body.dark-theme .form-section-content {
            color: #b0b0b0;
        }

        body.dark-theme .note {
            color: #888;
        }

        body.dark-theme .item-content:hover {
            background: #3a3a3a;
        }

        body.dark-theme .search-box,
        body.dark-theme input {
            background: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }

        body.dark-theme .modal {
            background: rgba(0,0,0,0.8);
        }

        body.dark-theme .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-theme .progress-bar {
            background: #3a3a3a;
        }

        body.dark-theme .header-subtitle {
            color: #999;
        }

        body.dark-theme .iacls-link {
            color: #5dade2;
        }

        body.dark-theme .nav-buttons {
            border-top-color: #3a3a3a;
        }

        body.dark-theme .nav-buttons button {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        body.dark-theme .nav-buttons button:hover:not(:disabled) {
            background: #4a4a4a;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .iacls-link {
            display: inline-block;
            transition: transform 0.2s;
        }

        .iacls-link:hover {
            transform: scale(1.05);
        }

        .iacls-logo {
            width: 50px;
            height: 50px;
        }

        .header-title {
            flex: 1;
        }

        h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 14px;
            color: #7f8c8d;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .theme-toggle {
            background: none;
            border: 2px solid #3498db;
            color: #3498db;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: #3498db;
            color: white;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .welcome-screen {
            text-align: center;
        }

        .welcome-screen h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .welcome-screen p {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .client-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .client-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .client-card:hover {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .client-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .client-case-number {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .client-progress {
            font-size: 12px;
            color: #27ae60;
            margin-bottom: 8px;
        }

        .client-modified {
            font-size: 11px;
            color: #95a5a6;
        }

        .client-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .client-actions button {
            flex: 1;
            font-size: 12px;
            padding: 6px 12px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Breadcrumb */
        .breadcrumb {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s;
        }

        .breadcrumb a:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        .breadcrumb span {
            margin: 0 8px;
            color: #7f8c8d;
        }

        /* Section List (Home page) */
        .section-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .section-link {
            display: block;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-decoration: none;
            color: #2c3e50;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .section-link:hover {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .section-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .section-description {
            font-size: 12px;
            color: #7f8c8d;
        }

        .section-progress {
            font-size: 12px;
            color: #27ae60;
            margin-top: 8px;
        }

        /* Checklist Items */
        .checklist-item {
            margin-left: 0;
            margin-bottom: 8px;
        }

        .item-content {
            display: flex;
            align-items: flex-start;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .item-content:hover {
            background: #f8f9fa;
        }

        .item-content input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 4px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .item-text {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        .item-text.checked {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .item-has-children .item-text {
            font-weight: 600;
            color: #2c3e50;
        }

        .item-children {
            margin-left: 28px;
            margin-top: 5px;
        }

        .item-fill {
            border-bottom: 1px solid #ddd;
            margin: 0 10px;
            flex: 1;
        }

        .form-section {
            background: #f8f9fa;
            border-left: 3px solid #3498db;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .form-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .form-section-title {
            font-weight: bold;
            color: #2c3e50;
        }

        .form-section-content {
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            color: #666;
        }

        .print-section-btn {
            padding: 3px 8px;
            font-size: 11px;
            background: #95a5a6;
            border-radius: 3px;
        }

        .print-section-btn:hover {
            background: #7f8c8d;
        }

        .note {
            color: #7f8c8d;
            font-style: italic;
            margin-left: 28px;
            font-size: 14px;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-buttons button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #3498db;
            color: white;
            transition: all 0.3s;
        }

        .nav-buttons button:hover:not(:disabled) {
            background: #2980b9;
        }

        .nav-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-center {
            flex: 1;
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-content label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        @media print {
            body {
                background: white;
            }
            header, .btn, .theme-toggle, .nav-buttons, .breadcrumb {
                display: none !important;
            }
            .card {
                box-shadow: none;
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            header {
                padding: 15px;
            }
            h1 {
                font-size: 20px;
            }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            .btn {
                padding: 8px 16px;
                font-size: 12px;
            }
            .section-list,
            .client-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <div class="header-left">
                    <a href="https://iacls.org" target="_blank" class="iacls-link" title="Visit IACLS.org">
                        <svg class="iacls-logo" version="1.0" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet">
                            <g transform="translate(0.000000,600.000000) scale(0.100000,-0.100000)" fill="#3498db" stroke="none">
                                <path d="M0 3000 l0 -3000 3000 0 3000 0 0 3000 0 3000 -3000 0 -3000 0 0 -3000z m1257 2299 c462 -119 684 -199 1008 -364 397 -203 739 -449 1046 -755 177 -176 305 -329 381 -456 52 -88 146 -272 178 -349 20 -49 18 -47 -102 80 -549 584 -935 920 -1213 1056 -71 35 -76 36 -45 12 274 -218 571 -486 820 -739 200 -204 490 -519 498 -544 2 -5 -10 -16 -26 -24 -27 -14 -31 -14 -47 4 -30 34 -118 68 -215 84 -199 34 -265 48 -324 67 -72 24 -181 88 -169 99 4 4 37 12 73 17 36 6 94 24 130 40 l65 30 -115 7 c-378 24 -620 117 -915 352 -49 39 -107 89 -128 111 l-38 40 89 6 c98 6 198 29 252 57 l35 19 -131 1 c-212 0 -326 33 -463 133 -60 43 -234 216 -252 249 -10 19 -9 20 12 14 48 -15 312 -19 412 -6 54 7 96 14 94 16 -2 2 -66 13 -143 24 -308 43 -414 77 -554 181 -103 75 -252 276 -351 471 -39 78 -47 108 -29 108 5 0 81 -18 167 -41z m3014 -1872 c19 -12 43 -39 54 -59 18 -33 18 -39 5 -67 -28 -59 -114 -161 -130 -154 -8 3 -61 21 -117 40 -57 19 -103 38 -103 42 0 4 31 45 68 92 105 130 154 153 223 106z m203 -216 c68 -45 83 -111 39 -170 -78 -105 -258 -323 -273 -331 -49 -26 -108 6 -97 52 5 19 17 26 63 36 123 25 185 94 188 207 1 63 -18 90 -77 106 l-39 10 23 27 c70 80 72 82 108 82 20 0 49 -9 65 -19z m-400 -106 c72 -24 150 -49 174 -55 77 -20 90 -80 29 -139 -39 -39 -116 -56 -212 -47 -38 4 -79 8 -90 8 -22 0 -135 -44 -135 -53 0 -3 30 -11 67 -17 74 -12 87 -23 104 -87 20 -72 5 -160 -44 -258 l-45 -87 37 21 c55 34 89 68 129 132 33 54 38 58 65 53 32 -7 95 -54 192 -144 l63 -60 -62 -78 c-113 -143 -177 -187 -301 -210 -85 -16 -92 -20 -144 -68 -47 -44 -393 -425 -475 -523 -80 -95 -373 -319 -521 -398 -44 -24 -58 -26 -115 -21 -58 5 -95 20 -340 142 -393 194 -611 329 -752 465 -89 85 -62 137 143 281 92 65 172 155 201 225 20 51 23 74 23 198 0 125 -3 151 -29 238 -16 53 -26 100 -23 103 10 11 74 -16 139 -58 92 -59 200 -150 303 -253 74 -73 99 -106 133 -175 22 -47 45 -104 51 -128 9 -42 8 -45 -36 -100 -25 -31 -51 -63 -57 -71 -20 -26 33 -2 189 84 83 45 179 97 215 114 132 66 409 263 503 358 l58 59 15 120 c32 246 50 305 101 342 83 58 242 130 292 131 13 1 83 -19 155 -44z m575 -140 c22 -25 31 -46 31 -71 0 -31 -13 -48 -125 -163 -141 -144 -180 -171 -219 -153 -15 6 -32 23 -38 37 -10 23 -7 32 32 88 70 99 186 242 220 270 42 36 62 34 99 -8z m90 -213 c46 -66 35 -110 -46 -182 -66 -58 -141 -100 -180 -100 -39 0 -77 32 -68 59 10 31 231 251 253 251 11 0 30 -13 41 -28z m15 -477 c107 -161 129 -198 112 -188 -49 28 -326 287 -315 296 2 2 22 16 44 30 l39 27 23 -28 c13 -15 56 -76 97 -137z m-1725 -1472 c1 -17 -3 -35 -9 -38 -5 -3 -10 2 -10 13 0 27 -44 65 -76 65 -27 0 -64 -33 -64 -57 0 -24 33 -57 100 -100 38 -25 76 -56 85 -70 25 -37 21 -118 -6 -163 -37 -60 -134 -90 -205 -63 -20 8 -29 8 -34 -1 -12 -19 -20 5 -26 78 l-4 68 19 -42 c21 -45 71 -83 109 -83 30 0 78 25 86 45 3 9 6 30 6 47 0 34 -42 81 -123 135 -50 34 -67 64 -67 114 0 76 59 125 142 117 29 -3 51 -1 55 6 9 13 21 -26 22 -71z m1629 -7 c3 -73 -10 -87 -28 -31 -16 48 -44 65 -108 65 -63 0 -98 -16 -140 -64 -71 -82 -49 -252 43 -322 37 -28 104 -41 150 -30 25 6 26 8 23 78 -3 69 -5 73 -35 94 l-31 21 100 0 c56 -1 95 -3 87 -5 -28 -8 -39 -37 -39 -97 0 -52 -4 -65 -23 -83 -72 -68 -221 -51 -315 33 -119 107 -108 261 26 358 55 40 121 56 212 52 l75 -4 3 -65z m-3055 54 c-40 -16 -46 -46 -51 -236 -5 -199 -1 -214 58 -214 26 0 31 7 60 77 32 76 104 262 131 338 8 22 19 40 23 40 5 0 34 -67 66 -150 65 -170 97 -238 135 -284 l27 -31 -94 1 c-74 0 -88 3 -70 11 28 14 28 34 -2 103 l-25 55 -55 0 -54 0 -21 -62 c-26 -75 -26 -95 -3 -101 9 -3 -55 -5 -143 -6 -88 0 -155 3 -148 7 24 15 32 63 39 237 l7 178 -29 24 -29 23 100 -1 c68 0 93 -3 78 -9z m787 -47 c0 -54 -13 -70 -25 -32 -10 29 -64 59 -108 59 -97 0 -167 -87 -167 -208 0 -169 158 -253 273 -144 30 29 31 28 16 -31 -10 -43 -10 -43 -74 -55 -138 -26 -204 -6 -262 81 -80 120 -37 298 88 361 50 25 62 27 156 24 l103 -3 0 -52z m186 35 c-13 -18 -16 -56 -16 -210 0 -214 -2 -208 88 -208 35 0 57 6 75 20 l26 21 -13 -38 c-7 -21 -18 -38 -25 -37 -6 1 -68 2 -137 3 -114 1 -125 3 -113 17 9 11 15 77 21 217 9 200 9 202 -13 220 -21 17 -19 17 50 17 l72 0 -15 -22z m1145 -6 c34 -17 65 -44 84 -71 28 -40 30 -49 30 -130 0 -80 -3 -92 -30 -137 -77 -123 -275 -147 -387 -46 -82 74 -105 180 -59 275 60 123 235 176 362 109z m431 -10 c40 -24 64 -89 48 -136 -11 -33 -53 -79 -82 -88 -19 -7 67 -144 132 -209 63 -64 131 -102 222 -125 74 -19 130 -14 206 21 69 31 82 32 52 0 -49 -52 -186 -76 -294 -51 -139 33 -254 117 -354 259 -30 43 -63 84 -73 90 -28 17 -23 27 11 27 71 0 119 56 106 123 -9 50 -46 79 -105 85 -48 4 -50 3 -57 -23 -4 -15 -5 -106 -2 -202 5 -171 6 -176 29 -194 24 -18 24 -19 -59 -19 l-83 0 15 22 c13 19 16 58 16 223 0 147 -3 205 -12 214 -20 21 246 6 284 -17z m-916 -347 c24 -24 25 -28 11 -48 -18 -28 -53 -33 -78 -11 -25 23 -24 49 3 68 30 21 35 20 64 -9z"/>
                                <path d="M1787 665 c-22 -65 -22 -65 18 -65 40 0 42 6 16 69 l-18 44 -16 -48z"/>
                                <path d="M3500 811 c-20 -10 -44 -36 -58 -62 -32 -59 -27 -153 12 -233 33 -67 70 -95 133 -102 62 -7 128 26 155 76 23 44 24 135 1 192 -48 127 -149 180 -243 129z"/>
                            </g>
                        </svg>
                    </a>
                    <div class="header-title">
                        <h1>Criminal-Defense Checklist</h1>
                        <div class="header-subtitle">By <a href="https://iacls.org" target="_blank" class="iacls-link">IACLS.org</a></div>
                    </div>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" onclick="toggleViewMode()" id="view-mode-toggle">📑 Paginated</button>
                    <button class="theme-toggle" onclick="toggleTheme()">🌓 Theme</button>
                </div>
            </div>
        </header>

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="card welcome-screen">
            <h2>Welcome to the Criminal Defense Checklist (Paginated)</h2>
            <p>Manage your case checklists with secure encryption and progress tracking.</p>
            <p>This version shows one checklist section at a time for easier navigation.</p>
            <button class="btn btn-primary" onclick="showClientsScreen()">Get Started</button>
        </div>

        <!-- Clients List Screen -->
        <div id="clients-screen" style="display: none;">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Client Checklists</h2>
                <input type="text" class="search-box" placeholder="🔍 Search clients..." oninput="filterClients(this.value)">
                <div id="no-clients" style="text-align: center; padding: 40px; color: #7f8c8d;">
                    <p>No client checklists yet. Create one to get started!</p>
                </div>
                <div id="client-list" class="client-list"></div>
                <button class="btn btn-primary" onclick="showNewClientModal()">+ New Client Checklist</button>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showEncryptionModal()">📤 Export All (Encrypted)</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('import-input').click()">📥 Import</button>
                    <input type="file" id="import-input" style="display: none;" accept=".json" onchange="importData(this)">
                </div>
            </div>
        </div>

        <!-- Checklist Container -->
        <div id="checklist-container" style="display: none;">
            <!-- Client Info Header -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h2 id="client-name" style="margin-bottom: 5px;">Client Name</h2>
                        <div id="section-title-display" style="color: #7f8c8d; font-size: 14px;">Master Checklist</div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="backToClients()">← Back to Clients</button>
                        <button class="btn btn-success" onclick="exportClient()">📤 Export</button>
                    </div>
                </div>
                <div class="progress-bar">
                    <div id="overall-progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="overall-progress-text">0% Complete (0/0)</div>
            </div>

            <!-- Breadcrumb Navigation -->
            <div id="breadcrumb" class="breadcrumb"></div>

            <!-- Main Content Area -->
            <div class="card">
                <div id="checklist-content"></div>

                <!-- Navigation Buttons -->
                <div class="nav-buttons" id="nav-buttons" style="display: none;">
                    <button id="prev-btn" onclick="navigatePrev()">← Previous</button>
                    <div class="nav-center">
                        <button class="btn btn-secondary" onclick="navigateToHome()">📋 Master Checklist</button>
                    </div>
                    <button id="next-btn" onclick="navigateNext()">Next →</button>
                </div>
            </div>
        </div>

        <!-- New Client Modal -->
        <div id="new-client-modal" class="modal">
            <div class="modal-content">
                <h3>New Client Checklist</h3>
                <label>Client Name *</label>
                <input type="text" id="new-client-name" placeholder="Enter client name">
                <label>Case Number (Optional)</label>
                <input type="text" id="new-client-case" placeholder="Enter case number">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('new-client-modal')">Cancel</button>
                    <button class="btn btn-primary" onclick="createNewClient()">Create</button>
                </div>
            </div>
        </div>

        <!-- Export Encryption Modal -->
        <div id="export-encryption-modal" class="modal">
            <div class="modal-content">
                <h3>🔒 Encrypt Export</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px;">Enter a strong password to encrypt your data.</p>
                <label>Password *</label>
                <input type="password" id="export-password" placeholder="Enter password">
                <label>Confirm Password *</label>
                <input type="password" id="export-password-confirm" placeholder="Confirm password">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('export-encryption-modal')">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmEncryptedExport()">Export</button>
                </div>
            </div>
        </div>

        <!-- Import Decryption Modal -->
        <div id="import-decryption-modal" class="modal">
            <div class="modal-content">
                <h3>🔓 Decrypt Import</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px;">Enter the password to decrypt your data.</p>
                <label>Password *</label>
                <input type="password" id="import-password" placeholder="Enter password">
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal('import-decryption-modal')">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmDecryption()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data
        let clients = [];
        let currentClient = null;
        let currentPath = []; // Track navigation path as array of item IDs ['home'] or ['section1', 'itemA', 'itemii']
        let pendingExportData = null;
        let pendingImportData = null;
        let template = null; // The checklist template loaded from file
        let viewMode = 'single-page'; // 'paginated' or 'single-page' - default to single-page
        const expandedItems = new Set();

        // Check for dark theme preference
        if (localStorage.getItem('darkTheme') === 'true') {
            document.body.classList.add('dark-theme');
        }

        // Load clients from localStorage
        function loadClients() {
            const stored = localStorage.getItem('criminalDefenseClients');
            if (stored) {
                clients = JSON.parse(stored);
            }
        }

        function saveClients() {
            localStorage.setItem('criminalDefenseClients', JSON.stringify(clients));
        }

        function checkForCachedTemplate() {
            const cached = localStorage.getItem('template');
            if (cached) {
                try {
                    const parsedTemplate = JSON.parse(cached);
                    if (!parsedTemplate || !Array.isArray(parsedTemplate) || parsedTemplate.length === 0) {
                        console.error('Cached template is empty or invalid');
                        localStorage.removeItem('template');
                        return;
                    }
                    template = parsedTemplate;
                    if (clients.length > 0) {
                        showClientsScreen();
                    }
                } catch (e) {
                    console.error('Failed to load cached template:', e);
                    localStorage.removeItem('template');
                }
            }
        }

        function autoLoadDefaultTemplate() {
            if (!template) {
                fetch('CriminalDefenseChecklist.txt')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Default template file not found');
                        }
                        return response.text();
                    })
                    .then(content => {
                        template = parseTemplate(content);
                        localStorage.setItem('template', JSON.stringify(template));
                        if (clients.length > 0) {
                            showClientsScreen();
                        }
                    })
                    .catch(error => {
                        console.error('Failed to load default template:', error);
                        const welcomeScreen = document.getElementById('welcome-screen');
                        if (welcomeScreen) {
                            welcomeScreen.innerHTML = `
                                <h2>Error Loading Template</h2>
                                <p style="color: #e74c3c;">
                                    Failed to load the checklist template. Please refresh the page to try again.
                                </p>
                                <p style="color: #7f8c8d; font-size: 14px;">
                                    Error: ${error.message}
                                </p>
                            `;
                        }
                    });
            }
        }

        function parseTemplate(content) {
            const lines = content.split('\n');
            const root = { title: 'Root', children: [], level: -1 };
            const stack = [root];
            let inForm = false;
            let formContent = [];
            let formParent = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                if (line.trim().toLowerCase() === '#end') {
                    break;
                }

                if (line.trim().toUpperCase() === '#FORM') {
                    inForm = true;
                    formContent = [];
                    formParent = stack[stack.length - 1];
                    continue;
                }

                if (line.trim().toUpperCase() === '#FORMEND') {
                    if (inForm && formParent) {
                        formParent.children.push({
                            type: 'form',
                            title: formParent.title || 'Form',
                            content: formContent.join('\n'),
                            level: formParent.level + 1,
                            id: generateId((formParent.title || 'form') + '-form')
                        });
                    }
                    inForm = false;
                    formContent = [];
                    formParent = null;
                    continue;
                }

                if (inForm) {
                    formContent.push(line);
                    continue;
                }

                if (!line.trim()) continue;
                if (line.trim().startsWith('#') && !line.trim().startsWith('#Note:')) continue;

                const level = (line.match(/^\t*/)[0] || '').length;
                const content = line.trim();

                if (content.startsWith('#Note:')) {
                    const noteText = content.substring(6).trim();
                    stack[stack.length - 1].children.push({
                        type: 'note',
                        text: noteText,
                        level: level
                    });
                    continue;
                }

                const hasFillable = content.endsWith('_');
                const keepOnPage = content.endsWith('*');
                const title = content.replace(/[_*]+$/, '').trim();

                const item = {
                    title: title,
                    text: title, // Add text property for compatibility
                    level: level,
                    type: 'checkbox',
                    children: [],
                    fillable: hasFillable,
                    keepOnPage: keepOnPage,
                    id: generateId(title)
                };

                while (stack.length > 0 && stack[stack.length - 1].level >= level) {
                    stack.pop();
                }

                stack[stack.length - 1].children.push(item);
                stack.push(item);
            }

            const result = root.children;

            if (!result || result.length === 0) {
                throw new Error('Template is empty or invalid - no checklist items found');
            }

            return result;
        }

        function generateId(text) {
            return text.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('darkTheme', document.body.classList.contains('dark-theme'));
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNewClientModal() {
            document.getElementById('new-client-name').value = '';
            document.getElementById('new-client-case').value = '';
            document.getElementById('new-client-modal').classList.add('active');
            document.getElementById('new-client-name').focus();
        }

        function createNewClient() {
            const name = document.getElementById('new-client-name').value.trim();
            const caseNumber = document.getElementById('new-client-case').value.trim();

            if (!name) {
                alert('Please enter a client name');
                return;
            }

            if (!template) {
                alert('Template not loaded. Please wait and try again.');
                return;
            }

            const client = {
                id: Date.now(),
                name: name,
                caseNumber: caseNumber || '',
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                checklist: JSON.parse(JSON.stringify(template)), // Deep copy
                state: {}
            };

            clients.push(client);
            saveClients();
            closeModal('new-client-modal');
            loadClient(client.id);
        }

        function showClientsScreen() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('clients-screen').style.display = 'block';
            document.getElementById('checklist-container').style.display = 'none';
            renderClientList();
        }

        function renderClientList() {
            const container = document.getElementById('client-list');
            const noClients = document.getElementById('no-clients');

            if (clients.length === 0) {
                container.innerHTML = '';
                noClients.style.display = 'block';
                return;
            }

            noClients.style.display = 'none';
            container.innerHTML = clients.map(client => {
                const progress = calculateProgress(client);
                const modified = new Date(client.modified);
                return `
                    <div class="client-card" onclick="loadClient(${client.id})">
                        <div class="client-name">${client.name}</div>
                        ${client.caseNumber ? `<div class="client-case-number">Case: ${client.caseNumber}</div>` : ''}
                        <div class="client-progress">${progress.percentage}% Complete (${progress.checked}/${progress.total})</div>
                        <div class="client-modified">Modified: ${modified.toLocaleString()}</div>
                        <div class="client-actions">
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); exportClient(${client.id})">Export</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteClient(${client.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterClients(searchTerm) {
            const cards = document.querySelectorAll('.client-card');
            const term = searchTerm.toLowerCase();

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        function loadClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            currentClient = client;
            expandedItems.clear();

            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('clients-screen').style.display = 'none';
            document.getElementById('checklist-container').style.display = 'block';

            document.getElementById('client-name').textContent =
                currentClient.name + (currentClient.caseNumber ? ` - ${currentClient.caseNumber}` : '');

            // Render based on view mode
            if (viewMode === 'paginated') {
                navigateToPath(['home']);
            } else {
                renderSinglePageView();
            }

            updateOverallProgress();
        }

        function backToClients() {
            if (currentClient) {
                currentClient.modified = new Date().toISOString();
                saveClients();
            }
            currentClient = null;
            currentPath = [];
            showClientsScreen();
        }

        function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client checklist?')) return;

            clients = clients.filter(c => c.id !== clientId);
            saveClients();
            renderClientList();
        }

        function calculateProgress(client) {
            let total = 0;
            let checked = 0;

            function countItems(items) {
                items.forEach(item => {
                    if (item.type === 'checkbox') {
                        total++;
                        if (client.state[item.id]?.checked) {
                            checked++;
                        }
                    }
                    if (item.children) {
                        countItems(item.children);
                    }
                });
            }

            countItems(client.checklist);
            return {
                total,
                checked,
                percentage: total > 0 ? Math.round((checked / total) * 100) : 0
            };
        }

        function updateOverallProgress() {
            if (!currentClient) return;

            const progress = calculateProgress(currentClient);
            document.getElementById('overall-progress-fill').style.width = progress.percentage + '%';
            document.getElementById('overall-progress-text').textContent =
                `${progress.percentage}% Complete (${progress.checked}/${progress.total})`;
        }

        // Navigation functions
        function navigateToHome() {
            navigateToPath(['home']);
        }

        function navigateToPath(path) {
            currentPath = [...path];
            window.location.hash = path.join('/');
            renderCurrentView();
            updateOverallProgress();
            window.scrollTo(0, 0);
        }

        function navigateToItem(itemId) {
            // Find the path to this item in the hierarchy
            const path = findPathToItem(currentClient.checklist, itemId);
            if (path) {
                navigateToPath(path);
            }
        }

        function findPathToItem(items, targetId, currentPath = []) {
            for (const item of items) {
                const newPath = [...currentPath, item.id];

                if (item.id === targetId) {
                    return newPath;
                }

                if (item.children && item.children.length > 0) {
                    const found = findPathToItem(item.children, targetId, newPath);
                    if (found) return found;
                }
            }
            return null;
        }

        function getItemByPath(path) {
            if (!path || path.length === 0 || path[0] === 'home') {
                return null; // Home/master list
            }

            let items = currentClient.checklist;
            let currentItem = null;

            for (const itemId of path) {
                currentItem = items.find(item => item.id === itemId);
                if (!currentItem) return null;
                items = currentItem.children || [];
            }

            return currentItem;
        }

        function getParentPath() {
            if (currentPath.length <= 1) return ['home'];
            return currentPath.slice(0, -1);
        }

        function renderCurrentView() {
            if (viewMode === 'single-page') {
                renderSinglePageView();
                return;
            }

            // Paginated view
            const container = document.getElementById('checklist-content');
            const breadcrumb = document.getElementById('breadcrumb');
            const navButtons = document.getElementById('nav-buttons');
            const sectionTitleDisplay = document.getElementById('section-title-display');

            if (currentPath.length === 0 || currentPath[0] === 'home') {
                // Render master checklist (list of all top-level sections)
                renderMasterChecklist(container);
                breadcrumb.innerHTML = '<strong>Master Checklist</strong>';
                breadcrumb.style.display = 'block';
                sectionTitleDisplay.textContent = 'Master Checklist';
                navButtons.style.display = 'none';
            } else {
                // Render specific item and its children
                const item = getItemByPath(currentPath);
                if (item) {
                    renderHierarchicalPage(container, item, currentPath);
                    renderBreadcrumbPath(breadcrumb, currentPath);
                    breadcrumb.style.display = 'block';
                    sectionTitleDisplay.textContent = item.title || item.text;
                    navButtons.style.display = 'flex';
                    updateNavButtons();
                }
            }
        }

        function renderHierarchicalPage(container, item, path) {
            container.innerHTML = '';

            // Render page title
            const titleDiv = document.createElement('h2');
            titleDiv.textContent = item.title || item.text;
            titleDiv.style.marginBottom = '20px';
            container.appendChild(titleDiv);

            if (!item.children || item.children.length === 0) {
                container.innerHTML += '<p style="color: #7f8c8d;">No items in this section.</p>';
                return;
            }

            // Separate children into sublists (items with children) and regular items
            const sublists = [];
            const regularItems = [];

            item.children.forEach(child => {
                if (child.type === 'checkbox' && child.children && child.children.length > 0) {
                    sublists.push(child);
                } else {
                    regularItems.push(child);
                }
            });

            // Render sublists as navigation links
            if (sublists.length > 0) {
                const sublistSection = document.createElement('div');
                sublistSection.style.marginBottom = '30px';

                const sublistTitle = document.createElement('h3');
                sublistTitle.textContent = 'Sublists';
                sublistTitle.style.color = '#2c3e50';
                sublistTitle.style.marginBottom = '15px';
                sublistTitle.style.fontSize = '18px';
                sublistSection.appendChild(sublistTitle);

                const sublistGrid = document.createElement('div');
                sublistGrid.className = 'section-list';

                sublists.forEach(subitem => {
                    const progress = calculateItemProgress(subitem);
                    const link = document.createElement('a');
                    link.href = `#${[...path, subitem.id].join('/')}`;
                    link.className = 'section-link';
                    link.onclick = (e) => {
                        e.preventDefault();
                        navigateToPath([...path, subitem.id]);
                    };

                    link.innerHTML = `
                        <div class="section-title">${subitem.title || subitem.text}</div>
                        <div class="section-progress">${progress.percentage}% complete (${progress.checked}/${progress.total} items)</div>
                    `;

                    sublistGrid.appendChild(link);
                });

                sublistSection.appendChild(sublistGrid);
                container.appendChild(sublistSection);
            }

            // Render regular items (items without children or non-checkbox items)
            if (regularItems.length > 0) {
                const itemsSection = document.createElement('div');

                if (sublists.length > 0) {
                    const itemsTitle = document.createElement('h3');
                    itemsTitle.textContent = 'Checklist Items';
                    itemsTitle.style.color = '#2c3e50';
                    itemsTitle.style.marginBottom = '15px';
                    itemsTitle.style.marginTop = '20px';
                    itemsTitle.style.fontSize = '18px';
                    itemsSection.appendChild(itemsTitle);
                }

                regularItems.forEach(child => {
                    renderItem(itemsSection, child, 0);
                });

                container.appendChild(itemsSection);
            }
        }

        function calculateItemProgress(item) {
            let total = 0;
            let checked = 0;

            function countItems(it) {
                if (it.type === 'checkbox') {
                    total++;
                    if (currentClient.state[it.id]?.checked) {
                        checked++;
                    }
                }
                if (it.children) {
                    it.children.forEach(countItems);
                }
            }

            countItems(item);

            return {
                total,
                checked,
                percentage: total > 0 ? Math.round((checked / total) * 100) : 0
            };
        }

        function renderBreadcrumbPath(breadcrumb, path) {
            const parts = ['<a href="#home" onclick="navigateToHome(); return false;">Master Checklist</a>'];

            let accumulatedPath = [];
            for (const itemId of path) {
                if (itemId === 'home') continue;

                accumulatedPath.push(itemId);
                const item = getItemByPath(accumulatedPath);
                if (item) {
                    const pathStr = accumulatedPath.join('/');
                    const isLast = accumulatedPath.length === path.length;

                    if (isLast) {
                        parts.push(`<strong>${item.title || item.text}</strong>`);
                    } else {
                        parts.push(`<a href="#${pathStr}" onclick="navigateToPath(${JSON.stringify(accumulatedPath)}); return false;">${item.title || item.text}</a>`);
                    }
                }
            }

            breadcrumb.innerHTML = parts.join(' <span>›</span> ');
        }

        function renderMasterChecklist(container) {
            container.innerHTML = `
                <h2 style="margin-bottom: 20px;">Checklist Sections</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Select a section to begin working on your checklist:</p>
                <div class="section-list"></div>
            `;

            const sectionList = container.querySelector('.section-list');

            currentClient.checklist.forEach(item => {
                const progress = calculateItemProgress(item);
                const link = document.createElement('a');
                link.href = `#${item.id}`;
                link.className = 'section-link';
                link.onclick = (e) => {
                    e.preventDefault();
                    navigateToPath([item.id]);
                };

                link.innerHTML = `
                    <div class="section-title">${item.title || item.text}</div>
                    <div class="section-progress">${progress.percentage}% complete (${progress.checked}/${progress.total} items)</div>
                `;

                sectionList.appendChild(link);
            });
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            // For now, simplify navigation - just enable "up" button
            const parentPath = getParentPath();
            prevBtn.textContent = '← Back';
            prevBtn.disabled = false;
            prevBtn.onclick = () => navigateToPath(parentPath);

            // Disable next for now (could add sibling navigation later)
            nextBtn.style.display = 'none';
        }

        function renderItem(container, item, level = 0) {
            if (item.type === 'form') {
                const formDiv = document.createElement('div');
                formDiv.className = 'form-section';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'form-section-header';

                const titleSpan = document.createElement('span');
                titleSpan.className = 'form-section-title';
                titleSpan.textContent = item.title;

                const printBtn = document.createElement('button');
                printBtn.className = 'btn print-section-btn';
                printBtn.textContent = '🖨️ Print Form';
                printBtn.onclick = () => printForm(item);

                headerDiv.appendChild(titleSpan);
                headerDiv.appendChild(printBtn);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'form-section-content';
                contentDiv.textContent = item.content;

                formDiv.appendChild(headerDiv);
                formDiv.appendChild(contentDiv);
                container.appendChild(formDiv);
                return;
            }

            if (item.type === 'note') {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note';
                noteDiv.textContent = item.text;
                container.appendChild(noteDiv);
                return;
            }

            if (item.type === 'checkbox') {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'checklist-item';
                itemDiv.style.marginLeft = (level * 20) + 'px';

                const itemContent = document.createElement('div');
                itemContent.className = 'item-content';
                if (item.children && item.children.length > 0) {
                    itemContent.classList.add('item-has-children');
                }

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = item.id;
                checkbox.checked = currentClient.state[item.id]?.checked || false;
                checkbox.onchange = (e) => toggleItem(item.id, e.target.checked);

                const label = document.createElement('span');
                label.className = 'item-text';
                label.textContent = item.text;
                label.onclick = () => {
                    checkbox.checked = !checkbox.checked;
                    toggleItem(item.id, checkbox.checked);
                };

                if (checkbox.checked) {
                    label.classList.add('checked');
                }

                itemContent.appendChild(checkbox);
                itemContent.appendChild(label);

                // Fill underline
                if (item.fill) {
                    const fillSpan = document.createElement('span');
                    fillSpan.className = 'item-fill';
                    itemContent.appendChild(fillSpan);
                }

                itemDiv.appendChild(itemContent);

                // Render children
                if (item.children && item.children.length > 0) {
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'item-children';
                    item.children.forEach(child => {
                        renderItem(childrenDiv, child, level + 1);
                    });
                    itemDiv.appendChild(childrenDiv);
                }

                container.appendChild(itemDiv);
            }
        }

        function toggleItem(itemId, checked) {
            if (!currentClient.state[itemId]) {
                currentClient.state[itemId] = {};
            }
            currentClient.state[itemId].checked = checked;

            updateParentCheckboxes();
            updateOverallProgress();
            saveChecklist();

            // Re-render to update styling
            renderCurrentSection();
        }

        function updateParentCheckboxes() {
            // Implement parent checkbox logic if needed
            // This would check/uncheck parent items based on children
        }

        function saveChecklist() {
            currentClient.modified = new Date().toISOString();
            saveClients();
        }

        function printForm(formItem) {
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${formItem.title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #2c3e50; }
                        pre { white-space: pre-wrap; font-family: monospace; }
                    </style>
                </head>
                <body>
                    <h1>${formItem.title}</h1>
                    <pre>${formItem.content}</pre>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Export/Import functions
        async function exportClient(clientId = null) {
            const client = clientId ? clients.find(c => c.id === clientId) : currentClient;
            if (!client) return;

            pendingExportData = {
                data: client,
                filename: `criminal-defense-${client.name.replace(/\s+/g, '-')}-${Date.now()}.json`,
                type: 'single'
            };

            showEncryptionModal();
        }

        function showEncryptionModal() {
            document.getElementById('export-password').value = '';
            document.getElementById('export-password-confirm').value = '';
            document.getElementById('export-encryption-modal').classList.add('active');
            document.getElementById('export-password').focus();
        }

        async function confirmEncryptedExport() {
            const password = document.getElementById('export-password').value;
            const confirmPassword = document.getElementById('export-password-confirm').value;

            if (!password) {
                alert('Please enter a password');
                return;
            }

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (password.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }

            try {
                const encrypted = await encryptData(pendingExportData.data, password);
                const data = JSON.stringify(encrypted, null, 2);
                downloadFile(data, pendingExportData.filename);

                closeModal('export-encryption-modal');
                pendingExportData = null;
                alert('Client exported and encrypted successfully!');
            } catch (error) {
                alert('Encryption failed: ' + error.message);
            }
        }

        async function encryptData(data, password) {
            const encoder = new TextEncoder();
            const dataString = JSON.stringify(data);
            const dataBuffer = encoder.encode(dataString);

            // Generate salt and IV
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));

            // Derive key from password
            const passwordBuffer = encoder.encode(password);
            const importedKey = await crypto.subtle.importKey(
                'raw',
                passwordBuffer,
                { name: 'PBKDF2' },
                false,
                ['deriveBits', 'deriveKey']
            );

            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                importedKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt']
            );

            // Encrypt
            const encryptedBuffer = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                dataBuffer
            );

            // Combine salt + IV + encrypted data
            const combined = new Uint8Array(salt.length + iv.length + encryptedBuffer.byteLength);
            combined.set(salt, 0);
            combined.set(iv, salt.length);
            combined.set(new Uint8Array(encryptedBuffer), salt.length + iv.length);

            // Convert to base64
            return {
                encrypted: true,
                data: btoa(String.fromCharCode(...combined))
            };
        }

        async function decryptData(encryptedObj, password) {
            const decoder = new TextDecoder();
            const encoder = new TextEncoder();

            // Decode from base64
            const combined = Uint8Array.from(atob(encryptedObj.data), c => c.charCodeAt(0));

            // Extract salt, IV, and encrypted data
            const salt = combined.slice(0, 16);
            const iv = combined.slice(16, 28);
            const encryptedData = combined.slice(28);

            // Derive key from password
            const passwordBuffer = encoder.encode(password);
            const importedKey = await crypto.subtle.importKey(
                'raw',
                passwordBuffer,
                { name: 'PBKDF2' },
                false,
                ['deriveBits', 'deriveKey']
            );

            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                importedKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );

            // Decrypt
            const decryptedBuffer = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                encryptedData
            );

            const decryptedText = decoder.decode(decryptedBuffer);
            return JSON.parse(decryptedText);
        }

        function downloadFile(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (importedData.encrypted) {
                        // Show decryption modal
                        pendingImportData = {
                            data: importedData,
                            isAll: Array.isArray(importedData)
                        };
                        document.getElementById('import-password').value = '';
                        document.getElementById('import-decryption-modal').classList.add('active');
                        document.getElementById('import-password').focus();
                    } else {
                        // Unencrypted import (for backwards compatibility)
                        if (Array.isArray(importedData)) {
                            clients = importedData;
                            saveClients();
                            alert(`Successfully imported ${clients.length} client(s)!`);
                        } else {
                            clients.push(importedData);
                            saveClients();
                            alert('Client imported successfully!');
                        }
                        renderClientList();
                    }
                } catch (error) {
                    alert('Failed to import: ' + error.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        async function confirmDecryption() {
            const password = document.getElementById('import-password').value;

            if (!password) {
                alert('Please enter the password');
                return;
            }

            try {
                const isAll = Array.isArray(pendingImportData.data);
                const decryptedData = await decryptData(pendingImportData.data, password);

                if (isAll) {
                    if (!Array.isArray(decryptedData)) {
                        throw new Error('Invalid backup file format');
                    }
                    clients = decryptedData;
                    saveClients();
                    alert(`Successfully imported ${clients.length} client(s)!`);
                } else {
                    if (!decryptedData.name || !decryptedData.checklist) {
                        throw new Error('Invalid client data');
                    }
                    clients.push(decryptedData);
                    saveClients();
                    alert('Client imported successfully!');
                }

                closeModal('import-decryption-modal');
                pendingImportData = null;
                renderClientList();
            } catch (error) {
                alert('Decryption failed. Please check your password.');
            }
        }

        // Handle URL hash navigation
        window.addEventListener('hashchange', () => {
            if (!currentClient || viewMode !== 'paginated') return;

            const hash = window.location.hash.slice(1);
            if (hash) {
                // Hash is a path like "section1/itemA/itemii"
                const path = hash.split('/');
                if (path[0] && path[0] !== 'home') {
                    navigateToPath(path);
                } else {
                    navigateToPath(['home']);
                }
            }
        });

        // View mode toggle
        function toggleViewMode() {
            viewMode = viewMode === 'paginated' ? 'single-page' : 'paginated';
            localStorage.setItem('viewMode', viewMode);
            updateViewModeButton();

            if (currentClient) {
                // Re-render with new view mode
                if (viewMode === 'paginated') {
                    navigateToPath(currentPath.length > 0 ? currentPath : ['home']);
                } else {
                    renderSinglePageView();
                }
            }
        }

        function updateViewModeButton() {
            const btn = document.getElementById('view-mode-toggle');
            if (btn) {
                btn.textContent = viewMode === 'paginated' ? '📄 Single Page' : '📑 Paginated';
            }
        }

        function loadViewMode() {
            const saved = localStorage.getItem('viewMode');
            if (saved) {
                viewMode = saved;
            }
            updateViewModeButton();
        }

        function renderSinglePageView() {
            const container = document.getElementById('checklist-content');
            const breadcrumb = document.getElementById('breadcrumb');
            const navButtons = document.getElementById('nav-buttons');
            const sectionTitleDisplay = document.getElementById('section-title-display');

            breadcrumb.style.display = 'none';
            navButtons.style.display = 'none';
            sectionTitleDisplay.textContent = 'All Sections';

            container.innerHTML = '<h2 style="margin-bottom: 20px;">Complete Checklist</h2>';

            // Render all sections in one page
            currentClient.checklist.forEach((section, index) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.style.marginBottom = '40px';
                sectionDiv.style.paddingBottom = '20px';
                if (index < currentClient.checklist.length - 1) {
                    sectionDiv.style.borderBottom = '2px solid #ecf0f1';
                }

                const titleDiv = document.createElement('h3');
                titleDiv.textContent = section.title || section.text;
                titleDiv.style.color = '#2c3e50';
                titleDiv.style.marginBottom = '15px';
                titleDiv.id = section.id;
                sectionDiv.appendChild(titleDiv);

                if (section.children && section.children.length > 0) {
                    section.children.forEach(child => {
                        renderItem(sectionDiv, child, 0);
                    });
                }

                container.appendChild(sectionDiv);
            });
        }

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadClients();
            loadViewMode();
            checkForCachedTemplate();
            autoLoadDefaultTemplate();
        });
    </script>
</body>
</html>
